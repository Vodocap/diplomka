<!DOCTYPE html>
<html lang="sk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <base href="./">
    <title>ML Pipeline - WASM App</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: white;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 0px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        header {
            background: #cc0000;
            color: white;
            padding: 30px;
            text-align: center;
        }

        header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        header p {
            opacity: 0.9;
            font-size: 1.1em;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            padding: 30px;
        }

        .section {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 0px;
            border: 2px solid #e9ecef;
        }

        .section.full-width {
            grid-column: 1 / -1;
        }

        h2 {
            color: #cc0000;
            margin-bottom: 20px;
            font-size: 1.5em;
            border-bottom: 2px solid #cc0000;
            padding-bottom: 10px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #495057;
        }

        select, input, textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #dee2e6;
            border-radius: 0px;
            font-size: 1em;
            transition: border-color 0.3s;
            background: white;
        }

        input[type="file"] {
            padding: 10px;
            cursor: pointer;
        }

        input[type="radio"] {
            width: auto;
            cursor: pointer;
        }

        select:focus, input:focus, textarea:focus {
            outline: none;
            border-color: #cc0000;
        }

        textarea {
            resize: vertical;
            min-height: 150px;
            font-family: 'Courier New', monospace;
        }

        button {
            background: #cc0000;
            color: white;
            border: none;
            padding: 14px 28px;
            border-radius: 0px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            margin-right: 10px;
            margin-bottom: 10px;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(204, 0, 0, 0.4);
        }

        button:active {
            transform: translateY(0);
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-secondary {
            background: #8b0000;
        }

        .btn-success {
            background: #cc0000;
        }

        /* Range slider styling */
        input[type="range"] {
            -webkit-appearance: none;
            appearance: none;
            background: #ddd;
            height: 6px;
            border-radius: 3px;
            outline: none;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #cc0000;
            cursor: pointer;
            border: 2px solid #fff;
            box-shadow: 0 0 2px rgba(0,0,0,0.3);
        }

        input[type="range"]::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #cc0000;
            cursor: pointer;
            border: 2px solid #fff;
            box-shadow: 0 0 2px rgba(0,0,0,0.3);
        }

        .info-box {
            background: white;
            padding: 15px;
            border-radius: 0px;
            margin-top: 15px;
            border-left: 4px solid #cc0000;
        }

        .info-box h3 {
            color: #cc0000;
            margin-bottom: 10px;
        }

        .info-box p {
            margin: 5px 0;
            color: #6c757d;
        }

        .status {
            padding: 12px;
            border-radius: 0px;
            margin-top: 15px;
            display: none;
        }

        .status.success {
            background: #ffe4e1;
            border: 1px solid #ffcccc;
            color: #8b0000;
            display: block;
        }

        .status.error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
            display: block;
        }

        .status.info {
            background: #fff0f0;
            border: 1px solid #ffdddd;
            color: #cc0000;
            display: block;
        }

        .options-list {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
        }

        .option-badge {
            background: #cc0000;
            color: white;
            padding: 8px 15px;
            border-radius: 0px;
            font-size: 0.9em;
        }

        .checkbox-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 10px;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px;
            background: #f8f9fa;
            border-radius: 0px;
        }

        .checkbox-item input[type="checkbox"] {
            width: auto;
            cursor: pointer;
        }

        .checkbox-item label {
            margin: 0;
            cursor: pointer;
            flex: 1;
        }

        .processors-order {
            margin-top: 15px;
            padding: 10px;
            background: #fff0f0;
            border: 2px solid #cc0000;
            border-radius: 0px;
            min-height: 50px;
        }

        .processors-order:empty::after {
            content: 'Vyberte procesory...';
            color: #666;
            font-style: italic;
        }

        .processor-chip {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: #cc0000;
            color: white;
            padding: 8px 12px;
            border-radius: 0px;
            margin: 5px;
        }

        .processor-chip .move-btn {
            background: rgba(255,255,255,0.3);
            border: none;
            color: white;
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 0px;
            font-size: 12px;
        }

        .processor-chip .move-btn:hover {
            background: rgba(255,255,255,0.5);
        }

        .processor-chip .remove-btn {
            background: #e74c3c;
            border: none;
            color: white;
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 0px;
            font-weight: bold;
        }

        .processor-chip .remove-btn:hover {
            background: #c0392b;
        }

        #loadingOverlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        #loadingOverlay.show {
            display: flex;
        }

        .spinner {
            border: 5px solid #f3f3f3;
            border-top: 5px solid #cc0000;
            border-radius: 0px;
            width: 60px;
            height: 60px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .metric-box {
            background: #cc0000;
            padding: 20px;
            border-radius: 0px;
            text-align: center;
            color: white;
        }

        .metric-label {
            font-size: 0.9em;
            opacity: 0.9;
            margin-bottom: 8px;
        }

        .metric-value {
            font-size: 2em;
            font-weight: bold;
        }

        #metricsContainer h4 {
            color: #495057;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 2px solid #dee2e6;
        }

        /* Data Inspection Modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.7);
            animation: fadeIn 0.3s;
        }

        .modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background-color: white;
            padding: 30px;
            border-radius: 0px;
            max-width: 90%;
            max-height: 90%;
            overflow: auto;
            position: relative;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }

        .modal-close {
            position: absolute;
            top: 15px;
            right: 20px;
            font-size: 30px;
            font-weight: bold;
            color: #aaa;
            cursor: pointer;
            background: none;
            border: none;
            padding: 0;
            line-height: 1;
        }

        .modal-close:hover {
            color: #cc0000;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            font-size: 0.9em;
        }

        .data-table th,
        .data-table td {
            border: 1px solid #dee2e6;
            padding: 10px;
            text-align: left;
        }

        .data-table th {
            background: #cc0000;
            color: white;
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .data-table tbody tr:nth-child(even) {
            background: #f8f9fa;
        }

        .data-table tbody tr:hover {
            background: #e9ecef;
        }

        .feature-info {
            background: #ffffff;
            padding: 15px;
            border-radius: 0px;
            margin: 10px 0;
            border: 1px solid #dee2e6;
            border-left: 3px solid #495057;
        }

        .feature-info h4 {
            color: #495057;
            margin-bottom: 10px;
            font-weight: 600;
        }

        .feature-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 10px;
        }

        .feature-badge {
            background: #f8f9fa;
            color: #495057;
            padding: 6px 12px;
            border-radius: 0px;
            font-size: 0.85em;
            border: 1px solid #dee2e6;
        }

        .feature-badge.kept {
            border-left: 3px solid #495057;
        }

        .feature-badge.dropped {
            border-left: 3px solid #adb5bd;
            opacity: 0.7;
        }

        .feature-idx {
            font-size: 0.9em;
            color: #6c757d;
            font-family: 'Courier New', monospace;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        /* Target Recommendation Styles */
        .target-recommendation {
            margin-top: 15px;
            padding: 15px;
            background: white;
            border: 2px solid #cc0000;
            border-radius: 0px;
            max-height: 600px;
            overflow-y: auto;
        }

        .target-recommendation h3 {
            color: #cc0000;
            margin-bottom: 10px;
        }

        /* Selection Details Styles */
        .selection-details-container {
            margin-top: 20px;
            padding: 15px;
            background: white;
            border: 2px solid #cc0000;
            border-radius: 0px;
            max-height: 600px;
            overflow: auto;
        }

        .selection-details-container h4 {
            color: #cc0000;
            margin-bottom: 15px;
            border-bottom: 2px solid #cc0000;
            padding-bottom: 8px;
        }

        .btn-analyze {
            background: #cc0000;
            width: 100%;
            margin-top: 10px;
            font-size: 1em;
        }

        .btn-analyze:hover {
            box-shadow: 0 5px 15px rgba(204, 0, 0, 0.4);
        }

        /* Column stats table */
        .column-stats {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85em;
            margin-bottom: 15px;
        }
        .column-stats th,
        .column-stats td {
            padding: 6px 10px;
            border: 1px solid #dee2e6;
            text-align: center;
        }
        .column-stats th {
            background: #cc0000;
            color: white;
            font-size: 0.9em;
        }
        .column-stats tbody tr:nth-child(even) {
            background: #f8f9fa;
        }
        .column-stats tbody tr:hover {
            background: #e9ecef;
            cursor: pointer;
        }
        .column-stats tbody tr.selected-row {
            background: #ffe4e1;
            font-weight: bold;
        }

        /* Selector comparison grid */
        .selector-compare-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        .selector-compare-card {
            background: white;
            border: 2px solid #dee2e6;
            padding: 15px;
            transition: border-color 0.2s;
        }
        .selector-compare-card:hover {
            border-color: #cc0000;
        }
        .selector-compare-card.active {
            border-color: #cc0000;
            background: #f0f8ff;
        }
        .selector-compare-card .card-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }
        .selector-compare-card .card-header input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }
        .selector-compare-card .card-header label {
            margin: 0;
            font-weight: bold;
            color: #cc0000;
            cursor: pointer;
            font-size: 1em;
        }
        .selector-compare-card .card-desc {
            font-size: 0.85em;
            color: #6c757d;
            margin-bottom: 10px;
        }
        .selector-compare-card .card-tags {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
        }
        .selector-compare-card .card-tag {
            font-size: 0.75em;
            padding: 2px 8px;
            background: #e9ecef;
            color: #495057;
        }
        .selector-compare-card .card-tag.warn {
            background: #fff3cd;
            color: #856404;
        }
        .selector-compare-card .card-params {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #dee2e6;
            display: none;
        }
        .selector-compare-card.active .card-params {
            display: block;
        }
        .selector-compare-card .card-params label {
            font-size: 0.85em;
            margin-bottom: 4px;
        }
        .selector-compare-card .card-params input {
            width: 100%;
            padding: 6px 10px;
            font-size: 0.9em;
        }

        /* Target method tabs */
        .target-method-tabs {
            display: flex;
            gap: 0;
            margin-bottom: 15px;
            border-bottom: 2px solid #dee2e6;
        }
        .target-method-tab {
            padding: 10px 20px;
            background: #f8f9fa;
            border: 2px solid #dee2e6;
            border-bottom: none;
            cursor: pointer;
            font-weight: 600;
            color: #6c757d;
            font-size: 0.9em;
            transition: all 0.2s;
            margin-bottom: -2px;
        }
        .target-method-tab:hover {
            color: #cc0000;
        }
        .target-method-tab.active {
            background: white;
            color: #cc0000;
            border-color: #cc0000;
            border-bottom-color: white;
        }
        .target-method-content {
            display: none;
        }
        .target-method-content.active {
            display: block;
        }

        /* Data Editor Modal Styles */
        .editor-modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.8);
            animation: fadeIn 0.3s;
        }

        .editor-modal.show {
            display: flex;
            align-items: stretch;
            justify-content: center;
        }

        .editor-modal-content {
            background-color: white;
            margin: 20px;
            border-radius: 0px;
            width: 100%;
            max-width: 95vw;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }

        .editor-header {
            background: #cc0000;
            color: white;
            padding: 15px 25px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
        }

        .editor-header h2 {
            color: white;
            border-bottom: none;
            margin: 0;
            padding: 0;
        }

        .editor-toolbar {
            background: #f8f9fa;
            padding: 12px 20px;
            border-bottom: 2px solid #dee2e6;
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
            flex-shrink: 0;
        }

        .editor-toolbar select, .editor-toolbar input {
            padding: 8px 10px;
            border: 2px solid #dee2e6;
            font-size: 0.9em;
            width: auto;
			min-width: 140px;
        }

        .editor-toolbar button {
            padding: 8px 16px;
            font-size: 0.85em;
            margin: 0;
        }

        .editor-toolbar .toolbar-group {
            display: flex;
            gap: 8px;
            align-items: center;
            padding: 5px 10px;
            background: white;
            border: 1px solid #dee2e6;
        }

        .editor-toolbar .toolbar-group label {
            margin: 0;
            font-size: 0.85em;
            white-space: nowrap;
        }

        .editor-body {
            flex: 1;
            overflow: auto;
            padding: 0;
        }

        .editor-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85em;
        }

        .editor-table th {
            background: #cc0000;
            color: white;
            padding: 10px 8px;
            position: sticky;
            top: 0;
            z-index: 10;
            font-weight: 600;
            text-align: center;
            border: 1px solid #a00;
            white-space: nowrap;
            cursor: pointer;
        }

        .editor-table th.selected-col {
            background: #8b0000;
            box-shadow: inset 0 -3px 0 #ffcc00;
        }

        .editor-table td.selected-col-cell {
            background: #fff3cd !important;
            border-left: 1px solid #ffc107;
            border-right: 1px solid #ffc107;
        }

        .editor-table th .col-actions {
            display: flex;
            gap: 4px;
            margin-top: 4px;
            justify-content: center;
        }

        .editor-table th .col-actions button {
            padding: 2px 6px;
            font-size: 0.75em;
            background: rgba(255,255,255,0.3);
            border: 1px solid rgba(255,255,255,0.5);
            color: white;
            margin: 0;
        }

        .editor-table th .col-actions button:hover {
            background: rgba(255,255,255,0.5);
        }

        .editor-table td {
            border: 1px solid #dee2e6;
            padding: 6px 8px;
            text-align: center;
        }

        .editor-table td.editable:hover {
            background: #ffe4e1;
            cursor: pointer;
        }

        .editor-table td input {
            width: 100%;
            padding: 4px;
            border: 2px solid #cc0000;
            text-align: center;
            font-size: 0.9em;
        }

        .editor-table tbody tr:nth-child(even) {
            background: #f8f9fa;
        }

        .editor-table tbody tr:hover {
            background: #e9ecef;
        }

        .editor-table td.row-num {
            background: #f0f0f0;
            font-weight: bold;
            color: #6c757d;
            width: 40px;
        }

        .editor-footer {
            background: #f8f9fa;
            padding: 10px 20px;
            border-top: 2px solid #dee2e6;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
        }

        .editor-footer .status-text {
            font-size: 0.9em;
            color: #6c757d;
        }

        /* Processor params in editor */
        .editor-proc-params {
            display: flex;
            gap: 8px;
            align-items: center;
            flex-wrap: wrap;
        }

        .editor-proc-params .param-item {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .editor-proc-params .param-item label {
            font-size: 0.8em;
            margin: 0;
            white-space: nowrap;
        }

        .editor-proc-params .param-item select,
        .editor-proc-params .param-item input {
            padding: 4px 6px;
            font-size: 0.85em;
            width: auto;
            min-width: 80px;
        }
    </style>
</head>
<body>
    <div id="loadingOverlay">
        <div class="spinner"></div>
    </div>

    <div class="container">
        <header>
            <h1>ML Pipeline Application</h1>
            <p>Kompletná Machine Learning Pipeline s podporou viacerých modelov a formátov</p>
        </header>

        <div class="main-content">
            <!-- Výber Komponenty -->
            <div class="section">
                <h2>1. Výber Pipeline</h2>

                <div class="form-group">
                    <label>Model:</label>
                    <select id="modelSelect">
                        <option value="">-- Vyberte model --</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Evaluation Mode:</label>
                    <select id="evalModeSelect">
                        <option value="">-- Auto --</option>
                        <option value="classification">Classification</option>
                        <option value="regression">Regression</option>
                    </select>
                </div>

                <div id="modelParamsContainer" style="display: none;">
                    <h3 style="margin-top: 20px; font-size: 1.1em;">Parametre modelu</h3>
                    <div class="form-group" id="knnKGroup" style="display: none;">
                        <label>K (počet susedov):</label>
                        <input type="number" id="knnK" placeholder="5" min="1" max="100" value="5">
                    </div>

                    <div class="form-group" id="treeMaxDepthGroup" style="display: none;">
                        <label>Max Depth (maximálna hĺbka stromu):</label>
                        <input type="number" id="treeMaxDepth" placeholder="10" min="1" max="50" value="10">
                    </div>
                </div>

                <button id="buildPipelineBtn">Vytvoriť Pipeline</button>
                
                <div id="pipelineStatus" class="status"></div>
            </div>

            <!-- Načítanie Dát -->
            <div class="section">
                <h2>2. Načítanie Dát</h2>
                
                <div class="form-group">
                    <label>Formát dát:</label>
                    <select id="dataFormatSelect">
                        <option value="csv">CSV</option>
                        <option value="json">JSON</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Spôsob zadania dát:</label>
                    <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                        <label style="cursor: pointer; display: flex; align-items: center; gap: 5px;">
                            <input type="radio" name="dataInputMethod" value="text" id="dataInputText" checked>
                            <span>Vložiť text</span>
                        </label>
                        <label style="cursor: pointer; display: flex; align-items: center; gap: 5px;">
                            <input type="radio" name="dataInputMethod" value="file" id="dataInputFile">
                            <span>Nahrať súbor</span>
                        </label>
                    </div>
                </div>

                <div class="form-group" id="textInputContainer">
                    <label>Vložte dáta:</label>
                    <textarea id="dataInput" placeholder="Vložte CSV alebo JSON dáta..."></textarea>
                </div>

                <div class="form-group" id="fileInputContainer" style="display: none;">
                    <label>Vyberte súbor:</label>
                    <input type="file" id="fileInput" accept=".csv,.json,.txt">
                    <div id="fileInfo" style="margin-top: 10px; font-size: 0.9em; color: #6c757d;"></div>
                    <button type="button" onclick="downloadSampleCSV()" style="margin-top: 10px; padding: 8px 16px; font-size: 0.9em; background: #cc0000;">
                        Stiahnuť vzorový CSV súbor
                    </button>
                </div>

                <button id="parseDataBtn">Načítať dáta</button>
                <div id="parseStatus" class="status"></div>

                <div id="targetSelectionArea" style="display: none; margin-top: 20px; padding-top: 20px; border-top: 2px solid #dee2e6;">
                    <h3 style="color: #cc0000; margin-bottom: 15px;">Výber cieľovej premennej</h3>
                    
                    <p style="color: #6c757d; margin-bottom: 15px;">
                        Porovnajte rôzne metódy analýzy cieľovej premennej. Mapa premenných ukáže zhodu medzi metódami.
                    </p>

                    <!-- Target analyzer method cards -->
                    <div id="targetAnalyzerGrid" class="selector-compare-grid">
                        <!-- Dynamicky generované karty analyzérov -->
                    </div>

                    <div style="margin-top: 20px; display: flex; gap: 10px; align-items: center;">
                        <button id="compareTargetAnalyzersBtn" style="flex: 0 0 auto;">
                            Porovnať vybrané metódy
                        </button>
                        <button id="selectAllAnalyzersBtn" class="btn-secondary" style="flex: 0 0 auto; padding: 10px 20px;">
                            Vybrať všetky
                        </button>
                        <span id="compareTargetStatus" style="font-size: 0.9em; color: #6c757d;"></span>
                    </div>
                    <div id="compareTargetAnalyzersStatus" class="status"></div>

                    <!-- Results: Target variable map -->
                    <div id="targetComparisonResultsArea" style="display: none; margin-top: 20px;">
                        <h4 style="color: #495057; margin-bottom: 10px;">Mapa premenných - vyberte cieľovú premennú</h4>
                        <p style="font-size: 12px; color: #6c757d; margin-bottom: 10px;">
                            Kliknite na premennú pre výber. Farba a bodky ukazujú, koľko metód ju označilo medzi top kandidátmi.
                        </p>
                        <div id="targetVariableMap"></div>
                    </div>

                    <input type="hidden" id="targetColumnSelect" value="">

                    <div class="form-group" style="margin-top: 20px;">
                        <label>Train/Test Split (% pre tréning):</label>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <input type="range" id="trainTestSplit" min="50" max="95" value="80" step="5" style="flex: 1;">
                            <span id="splitValue" style="min-width: 60px; font-weight: bold; color: #cc0000;">80%</span>
                        </div>
                        <div style="font-size: 0.85em; color: #6c757d; margin-top: 5px;">
                            Train: <span id="trainPercent">80%</span> | Test: <span id="testPercent">20%</span>
                        </div>
                    </div>

                    <button id="confirmTargetBtn">Potvrdiť výber a načítať do pipeline</button>
                    <div id="dataStatus" class="status"></div>
                </div>

                <div style="margin-top: 15px; display: flex; gap: 10px; flex-wrap: wrap;">
                    <button id="editDataBtn" disabled style="flex: 1; min-width: 150px; background: #27ae60;">
                        Upraviť dáta
                    </button>
                    <button id="inspectDataBtn" disabled style="flex: 1; min-width: 150px;">
                        Zobraziť dáta
                    </button>
                    <button id="inspectProcessedBtn" disabled style="flex: 1; min-width: 150px;">
                        Zobraziť spracované dáta
                    </button>
                </div>
            </div>

            <!-- Prieskum príznakov (Feature Exploration) -->
            <div class="section full-width" id="featureExplorationSection" style="display: none;">
                <h2>Prieskum a výber príznakov</h2>
                <p style="color: #6c757d; margin-bottom: 15px;">
                    Porovnajte rôzne metódy výberu príznakov na vašich dátach. 
                    Po porovnaní môžete natrénovať model s features vybranými jednotlivými selektormi a porovnať výsledky.
                </p>

                <div id="selectorCompareGrid" class="selector-compare-grid">
                    <!-- Dynamicky generované karty selektorov -->
                </div>

                <div style="margin-top: 20px; display: flex; gap: 10px; align-items: center;">
                    <button id="compareSelectorBtn" style="flex: 0 0 auto;">
                        Porovnať vybrané selektory
                    </button>
                    <button id="selectAllSelectorsBtn" class="btn-secondary" style="flex: 0 0 auto; padding: 10px 20px;">
                        Vybrať všetky
                    </button>
                    <span id="compareStatus" style="font-size: 0.9em; color: #6c757d;"></span>
                </div>
                <div id="compareSelectorStatus" class="status"></div>

                <!-- Výsledky porovnania a trénovania -->
                <div id="comparisonResultsArea" style="display: none; margin-top: 20px;">
                    <div style="display: flex; gap: 10px; align-items: center; margin-bottom: 15px; flex-wrap: wrap;">
                        <button id="trainAllSelectorsBtn" style="background: #cc0000; color: white; border: none; padding: 10px 20px; cursor: pointer; font-size: 14px;">
                            Natrénovať a porovnať všetky varianty
                        </button>
                        <span id="trainCompareStatus" style="font-size: 0.9em; color: #6c757d;"></span>
                    </div>
                    <div id="selectorTrainingResults"></div>
                </div>
            </div>

            <!-- Predikcia -->
            <div class="section full-width">
                <h2>Dostupné Možnosti</h2>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px;">
                    <div class="info-box">
                        <h3>Dostupné Modely</h3>
                        <div id="modelsInfo" class="options-list"></div>
                    </div>
                    
                    <div class="info-box">
                        <h3>Procesory</h3>
                        <div id="processorsInfo" class="options-list"></div>
                    </div>
                    
                    <div class="info-box">
                        <h3>Selektory</h3>
                        <div id="selectorsInfo" class="options-list"></div>
                    </div>
                </div>

                <div class="info-box" id="currentPipelineInfo" style="display: none; margin-top: 20px;">
                    <h3>Aktuálny Pipeline</h3>
                    <p><strong>Model:</strong> <span id="currentModel">-</span></p>
                    <p><strong>Processors:</strong> <span id="currentProcessor">-</span></p>
                    <p><strong>Eval Mode:</strong> <span id="currentEvalMode">-</span></p>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        let factory, pipeline, dataLoader;
        let availableOptions = null;
        let WasmDataLoaderClass = null;

        // Make functions globally available for inline handlers
        window.downloadSampleCSV = downloadSampleCSV;
        window.closeModal = closeModal;
        window.switchTargetTab = switchTargetTab;
        window.closeDataEditor = closeDataEditor;
        window.editorApplyProcessor = editorApplyProcessor;
        window.editorDeleteColumn = editorDeleteColumn;
        window.editorReplaceAll = editorReplaceAll;
        window.editorApplyAndClose = editorApplyAndClose;
        window.updateEditorProcessorParams = updateEditorProcessorParams;

        // Helper functions
        function calculateFeatureReduction(before, after) {
            return ((1 - after / before) * 100).toFixed(1);
        }

        function formatFeatureBadge(name, index, score, metricName, badgeClass) {
            const scoreText = score !== null && score !== undefined 
                ? ` = ${score.toFixed(4)} (${metricName})` 
                : '';
            return `<span class="feature-badge ${badgeClass}">${name} <span class="feature-idx">[${index}]${scoreText}</span></span>`;
        }

        function convertWasmResult(result) {
            if (result instanceof Map) {
                const obj = {};
                result.forEach((val, key) => {
                    obj[key] = convertWasmResult(val);
                });
                return obj;
            }
            if (Array.isArray(result)) {
                return result.map(item => convertWasmResult(item));
            }
            return result;
        }

        async function initApp() {
            try {
                showLoading(true);
                
                // Diagnostika pre GitHub Pages
                console.log('=== WASM INITIALIZATION DEBUG ===');
                console.log('Current URL:', window.location.href);
                console.log('Base URI:', document.baseURI);
                console.log('Origin:', window.location.origin);
                console.log('Pathname:', window.location.pathname);
                
                // Auto-detect base path for GitHub Pages
                const basePath = document.baseURI.endsWith('/') ? document.baseURI : document.baseURI + '/';
                const wasmPath = new URL('./pkg/wasm.js', basePath).href;
                console.log('Trying to load WASM from:', wasmPath);
                
                let wasmModule;
                try {
                    wasmModule = await import('./pkg/wasm.js');
                    console.log('✓ WASM module loaded successfully');
                } catch (importError) {
                    console.error('✗ Failed to import WASM module:', importError);
                    console.error('Import error details:', {
                        message: importError.message,
                        name: importError.name,
                        stack: importError.stack
                    });
                    throw new Error(`Nepodarilo sa načítať WASM modul z ./pkg/wasm.js\n\nChyba: ${importError.message}\n\nSkontrolujte:\n1. Či existuje súbor pkg/wasm.js\n2. Či je GitHub Pages správne nasadený\n3. Konzolu prehliadača pre ďalšie chyby`);
                }
                
                const init = wasmModule.default || wasmModule.init;
                const WasmFactory = wasmModule.WasmFactory;
                const WasmMLPipeline = wasmModule.WasmMLPipeline;
                WasmDataLoaderClass = wasmModule.WasmDataLoader; // Uložíme do globálnej premennej

                console.log('WASM exports:', {
                    init: typeof init,
                    WasmFactory: typeof WasmFactory,
                    WasmMLPipeline: typeof WasmMLPipeline,
                    WasmDataLoader: typeof WasmDataLoaderClass,
                    allExports: Object.keys(wasmModule)
                });

                if (!init || !WasmFactory) {
                    throw new Error('WASM module exports not found (wasm.js or pkg missing)');
                }

                console.log('Initializing WASM...');
                await init();
                console.log('✓ WASM initialized');

                factory = new WasmFactory();
                pipeline = new WasmMLPipeline();
                console.log('✓ Factory and Pipeline created');

                console.log('Fetching available options...');
                availableOptions = factory.getAvailableOptions();
                console.log('✓ Available options:', availableOptions);
                
                if (!availableOptions || !availableOptions.models || availableOptions.models.length === 0) {
                    throw new Error('Žiadne modely/selektory neboli načítané z WASM Factory. WASM modul môže byť nesprávne skompilovaný.');
                }

                console.log('Populating UI options...');
                populateOptions();
                console.log('✓ UI populated');
                
                console.log('Setting up event listeners...');
                setupEventListeners();
                console.log('✓ Event listeners ready');

                console.log('=== INITIALIZATION COMPLETE ===');
                showStatus('info', 'Aplikácia pripravená!', 'parseStatus');
            } catch (error) {
                console.error('=== INIT ERROR ===');
                console.error('Init error:', error);
                console.error('Error stack:', error.stack);
                const message = (error && error.message) ? error.message : String(error);
                showStatus('error', `Chyba pri načítaní WASM: ${message}\n\nOtvorte Developer Console (F12) pre viac detailov.`, 'parseStatus');
                
                // Zobrazenie viditeľného erroru na stránke
                document.body.innerHTML += `
                    <div style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); 
                                background: #f8d7da; border: 3px solid #f5c6cb; padding: 30px; 
                                border-radius: 10px; max-width: 600px; z-index: 9999; box-shadow: 0 10px 40px rgba(0,0,0,0.3);">
                        <h2 style="color: #721c24; margin-bottom: 15px;">Chyba inicializácie WASM</h2>
                        <p style="color: #721c24; margin-bottom: 10px;"><strong>Chyba:</strong> ${message}</p>
                        <p style="color: #721c24; font-size: 0.9em;">Otvorte Developer Console (F12) pre viac informácií.</p>
                        <hr style="margin: 15px 0; border-color: #f5c6cb;">
                        <p style="color: #721c24; font-size: 0.85em;">
                            <strong>Možné príčiny:</strong><br>
                            • WASM súbory neboli správne nasadené na GitHub Pages<br>
                            • Nesprávne MIME typy pre .wasm súbory<br>
                            • CORS problémy pri načítaní modulov<br>
                            • Cesta k pkg/wasm.js je nesprávna
                        </p>
                    </div>
                `;
            } finally {
                showLoading(false);
            }
        }

        function populateOptions() {
            if (!availableOptions) return;

            const modelSelect = document.getElementById('modelSelect');
            availableOptions.models.forEach(m => {
                const opt = document.createElement('option');
                opt.value = m.name;
                opt.textContent = `${m.name} - ${m.description}`;
                modelSelect.appendChild(opt);
            });

            displayInfo();
        }

        function displayInfo() {
            const modelsDiv = document.getElementById('modelsInfo');
            availableOptions.models.forEach(m => {
                const badge = document.createElement('span');
                badge.className = 'option-badge';
                badge.textContent = m.name;
                badge.title = m.description;
                modelsDiv.appendChild(badge);
            });

            const processorsDiv = document.getElementById('processorsInfo');
            availableOptions.processors.forEach(p => {
                const badge = document.createElement('span');
                badge.className = 'option-badge';
                badge.textContent = p.name;
                processorsDiv.appendChild(badge);
            });

            const selectorsDiv = document.getElementById('selectorsInfo');
            availableOptions.selectors.forEach(s => {
                const badge = document.createElement('span');
                badge.className = 'option-badge';
                badge.textContent = s.name;
                selectorsDiv.appendChild(badge);
            });
        }

        function setupEventListeners() {
            document.getElementById('buildPipelineBtn').onclick = buildPipeline;
            document.getElementById('parseDataBtn').onclick = parseData;
            document.getElementById('confirmTargetBtn').onclick = confirmTarget;
            document.getElementById('inspectDataBtn').onclick = inspectData;
            document.getElementById('inspectProcessedBtn').onclick = inspectProcessedData;
            document.getElementById('editDataBtn').onclick = openDataEditor;
            document.getElementById('analyzeTargetBtn').onclick = analyzeTargets;
            document.getElementById('compareSelectorBtn').onclick = compareSelectors;
            document.getElementById('selectAllSelectorsBtn').onclick = toggleAllSelectors;
            document.getElementById('trainAllSelectorsBtn').onclick = trainAllSelectors;
            
            // Data input method radio buttons
            document.getElementById('dataInputText').onchange = toggleDataInputMethod;
            document.getElementById('dataInputFile').onchange = toggleDataInputMethod;
            
            // Train/Test split slider
            document.getElementById('trainTestSplit').oninput = function(e) {
                const trainPercent = parseInt(e.target.value);
                const testPercent = 100 - trainPercent;
                document.getElementById('splitValue').textContent = `${trainPercent}%`;
                document.getElementById('trainPercent').textContent = `${trainPercent}%`;
                document.getElementById('testPercent').textContent = `${testPercent}%`;
            };
            
            // File input change listener
            document.getElementById('fileInput').onchange = function(e) {
                const file = e.target.files[0];
                if (file) {
                    const fileInfo = document.getElementById('fileInfo');
                    fileInfo.textContent = `Vybraný súbor: ${file.name} (${(file.size / 1024).toFixed(2)} KB)`;
                    
                    // Auto-detect format from file extension
                    const ext = file.name.split('.').pop().toLowerCase();
                    if (ext === 'csv') {
                        document.getElementById('dataFormatSelect').value = 'csv';
                    } else if (ext === 'json') {
                        document.getElementById('dataFormatSelect').value = 'json';
                    }
                }
            };

            document.getElementById('modelSelect').onchange = function() {
                updateModelParams(this.value);
            };

            // Update editor processor params when processor changes
            document.getElementById('editorProcessorSelect').onchange = function() {
                updateEditorProcessorParams(this.value);
            };
        }
        
        function hideAllParamFields() {
            document.getElementById('modelParamsContainer').style.display = 'none';
            document.getElementById('knnKGroup').style.display = 'none';
            document.getElementById('treeMaxDepthGroup').style.display = 'none';
        }

        function updateModelParams(modelName) {
            hideAllParamFields();
            
            if (!modelName) return;

            const params = factory.getModelParams(modelName);
            
            if (params.length > 0) {
                document.getElementById('modelParamsContainer').style.display = 'block';
                
                params.forEach(param => {
                    if (param === 'k') {
                        document.getElementById('knnKGroup').style.display = 'block';
                    } else if (param === 'max_depth') {
                        document.getElementById('treeMaxDepthGroup').style.display = 'block';
                    }
                });
            }
        }

        async function buildPipeline() {
            try {
                showLoading(true);
                
                const model = document.getElementById('modelSelect').value;
                const evalMode = document.getElementById('evalModeSelect').value;

                if (!model) throw new Error('Vyberte model');

                // Validácia evaluation_mode vs model
                if (evalMode) {
                    if (model === 'linreg' && evalMode === 'classification') {
                        showStatus('error', 'Upozornenie: Lineárna regresia (linreg) vyžaduje evaluation_mode = "regression", nie "classification".', 'pipelineStatus');
                        if (!confirm('Vybrali ste nekompatibilný evaluation_mode.\n\nModel: Lineárna Regresia (linreg)\nEvaluation Mode: classification\n\nMal by byť: regression\n\nChcete pokračovať?')) {
                            return;
                        }
                    }
                    if (model === 'logreg' && evalMode === 'regression') {
                        showStatus('error', 'Upozornenie: Logistická regresia (logreg) vyžaduje evaluation_mode = "classification", nie "regression".', 'pipelineStatus');
                        if (!confirm('Vybrali ste nekompatibilný evaluation_mode.\n\nModel: Logistická Regresia (logreg)\nEvaluation Mode: regression\n\nMal by byť: classification\n\nChcete pokračovať?')) {
                            return;
                        }
                    }
                }

                // Zozbierať parametre
                const modelParams = [];

                const knnK = document.getElementById('knnK').value;
                if (knnK && model === 'knn') {
                    modelParams.push(['k', knnK]);
                }

                const treeMaxDepth = document.getElementById('treeMaxDepth').value;
                if (treeMaxDepth && model === 'tree') {
                    modelParams.push(['max_depth', treeMaxDepth]);
                }

                const config = {
                    model: model,
                    processors: [],
                    processor: null,
                    selector: null,
                    evaluation_mode: evalMode || null,
                    model_params: modelParams.length > 0 ? modelParams : null,
                    selector_params: null,
                    processor_params: null
                };

                const result = await pipeline.buildFromConfig(config);
                
                document.getElementById('currentPipelineInfo').style.display = 'block';
                document.getElementById('currentModel').textContent = result.model_name;
                document.getElementById('currentProcessor').textContent = 'Dáta upravené manuálne';
                document.getElementById('currentEvalMode').textContent = result.evaluation_mode;
                
                window.pipelineBuilt = true;
                showStatus('success', 'Pipeline vytvorený!', 'pipelineStatus');
            } catch (error) {
                console.error('Build pipeline error:', error);
                showStatus('error', `Chyba: ${error}`, 'pipelineStatus');
            } finally {
                showLoading(false);
            }
        }

        function toggleDataInputMethod() {
            const method = document.querySelector('input[name="dataInputMethod"]:checked').value;
            const textContainer = document.getElementById('textInputContainer');
            const fileContainer = document.getElementById('fileInputContainer');
            
            if (method === 'text') {
                textContainer.style.display = 'block';
                fileContainer.style.display = 'none';
            } else {
                textContainer.style.display = 'none';
                fileContainer.style.display = 'block';
            }
        }

        function downloadSampleCSV() {
            const csvContent = `age,income,credit_score,debt_ratio,employment_years,education_level,num_accounts,account_balance,loan_amount,monthly_payment,savings,investment_score,property_value,approved
25,50000,700,0.35,3,2,4,12500,15000,450,8000,65,0,1
35,75000,750,0.28,8,3,6,28000,22000,680,25000,78,180000,1
45,60000,650,0.42,15,2,3,8500,28000,820,15000,58,150000,0
22,30000,600,0.48,1,1,2,3500,12000,380,2500,42,0,0
50,90000,800,0.22,20,4,8,45000,35000,920,55000,88,320000,1
30,55000,680,0.38,5,3,5,15000,18000,520,12000,68,0,1
40,80000,720,0.30,12,3,7,32000,25000,750,30000,75,220000,1
28,45000,640,0.44,4,2,3,7500,20000,610,6000,55,0,0
55,95000,790,0.20,25,4,9,58000,40000,980,68000,92,450000,1
32,62000,710,0.33,7,3,6,18500,21000,640,16000,72,125000,1
38,72000,730,0.29,10,3,7,26000,24000,710,28000,76,195000,1
27,48000,660,0.40,3,2,4,9500,17000,550,9500,60,0,0
52,88000,780,0.24,22,4,8,42000,32000,890,52000,86,380000,1
29,51000,670,0.37,4,2,5,11500,19000,570,11000,63,0,1
43,68000,700,0.32,13,3,6,21000,23000,690,22000,74,175000,1
24,42000,630,0.45,2,2,3,6000,14000,480,5000,50,0,0
48,82000,760,0.26,18,3,7,35000,28000,820,38000,82,280000,1
31,58000,690,0.36,6,3,5,14000,20000,600,13500,66,110000,1
36,70000,725,0.31,9,3,6,24000,26000,730,26000,77,200000,1
26,46000,655,0.41,3,2,4,8000,16000,520,7500,58,0,0
53,92000,795,0.21,24,4,9,50000,38000,950,62000,90,410000,1
33,64000,705,0.34,8,3,6,19500,22000,660,18000,70,140000,1
41,76000,740,0.27,14,3,7,30000,27000,780,32000,80,240000,1
23,38000,620,0.47,1,1,2,4500,13000,420,3500,45,0,0
49,85000,770,0.25,19,4,8,40000,33000,870,48000,84,350000,1
34,66000,715,0.30,9,3,6,22000,24000,700,24000,73,160000,1
39,74000,735,0.28,11,3,7,28000,26000,760,29000,78,210000,1
28,49000,665,0.39,4,2,4,10000,18000,560,10500,62,0,0
54,94000,785,0.23,23,4,9,55000,36000,930,65000,89,430000,1
30,56000,685,0.35,5,3,5,13500,19000,590,14500,67,95000,1`;
            
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            
            link.setAttribute('href', url);
            link.setAttribute('download', 'sample_data.csv');
            link.style.visibility = 'hidden';
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        async function getDataString() {
            const method = document.querySelector('input[name="dataInputMethod"]:checked').value;
            if (method === 'text') {
                const data = document.getElementById('dataInput').value;
                if (!data) throw new Error('Vložte dáta');
                return data;
            } else {
                const fileInput = document.getElementById('fileInput');
                const file = fileInput.files[0];
                if (!file) throw new Error('Vyberte súbor');
                return await new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = (e) => resolve(e.target.result);
                    reader.onerror = () => reject(new Error('Chyba pri čítaní súboru'));
                    reader.readAsText(file);
                });
            }
        }

        async function parseData() {
            try {
                showLoading(true);
                const format = document.getElementById('dataFormatSelect').value;
                const data = await getDataString();

                window.rawDataString = data;
                window.dataFormat = format;

                dataLoader = new WasmDataLoaderClass(format);
                const columns = await dataLoader.getAvailableColumns(data);
                window.parsedColumns = columns;

                // Target selection now via comparison map

                document.getElementById('targetSelectionArea').style.display = 'block';
                document.getElementById('inspectDataBtn').disabled = false;
                document.getElementById('inspectProcessedBtn').disabled = true;
                document.getElementById('editDataBtn').disabled = false;

                // Show feature exploration section and populate selector cards
                document.getElementById('featureExplorationSection').style.display = 'block';
                populateComparisonSelectors();
                populateTargetAnalyzerMethods();

                showStatus('success', `Dáta načítané: ${columns.length} stĺpcov nájdených. Porovnajte metódy analýzy a vyberte cieľovú premennú.`, 'parseStatus');
            } catch (error) {
                showStatus('error', `Chyba: ${error}`, 'parseStatus');
            } finally {
                showLoading(false);
            }
        }

        async function confirmTarget() {
            try {
                showLoading(true);
                const targetColumn = document.getElementById('targetColumnSelect').value;
                if (!targetColumn) {
                    showStatus('error', 'Vyberte cieľový stĺpec', 'dataStatus');
                    return;
                }

                const data = window.rawDataString;
                const format = window.dataFormat;
                if (!data) {
                    showStatus('error', 'Najprv načítajte dáta', 'dataStatus');
                    return;
                }

                const result = await pipeline.loadData(data, targetColumn, format);

                const trainPercent = parseInt(document.getElementById('trainTestSplit').value) / 100;
                window.trainTestRatio = trainPercent;

                document.getElementById('inspectDataBtn').disabled = false;

                showStatus('success', `${result.message} (Train: ${Math.round(trainPercent * 100)}%, Test: ${Math.round((1 - trainPercent) * 100)}%)`, 'dataStatus');
            } catch (error) {
                showStatus('error', `Chyba: ${error}`, 'dataStatus');
            } finally {
                showLoading(false);
            }
        }

        async function compareTargetAnalyzers() {
            try {
                const data = window.rawDataString;
                const format = window.dataFormat;
                if (!data) {
                    showStatus('error', 'Najprv načítajte dáta', 'compareTargetAnalyzersStatus');
                    return;
                }

                // Collect selected analyzers
                const selectedMethods = [];
                document.querySelectorAll('#targetAnalyzerGrid .selector-compare-card.active').forEach(card => {
                    const name = card.id.replace('target_card_', '');
                    selectedMethods.push(name);
                });

                if (selectedMethods.length === 0) {
                    showStatus('error', 'Vyberte aspoň jednu metódu analýzy', 'compareTargetAnalyzersStatus');
                    return;
                }

                showLoading(true);
                
                // Odhadujeme koľko to bude trvať
                const dataSize = data.split('\n').length;
                const hasMI = selectedMethods.includes('mutual_information');
                let estimatedTime = '';
                if (hasMI) {
                    if (dataSize > 1000) {
                        estimatedTime = ' (môže trvať 30-60s, prosím čakajte...)';
                    } else if (dataSize > 500) {
                        estimatedTime = ' (môže trvať 10-20s, prosím čakajte...)';
                    } else if (dataSize > 100) {
                        estimatedTime = ' (môže trvať 5-10s, prosím čakajte...)';
                    }
                }
                
                showStatus('info', `Porovnávam ${selectedMethods.length} metód${estimatedTime}...`, 'compareTargetAnalyzersStatus');

                const rawResult = await pipeline.compareTargetAnalyzers(data, format, selectedMethods);
                const result = convertWasmResult(rawResult);

                // Store for later use
                window._lastTargetComparison = result;

                // Show target variable map
                buildTargetVariableMap(result);
                document.getElementById('targetComparisonResultsArea').style.display = 'block';

                showStatus('success', `Porovnanie dokončené: ${selectedMethods.length} metód na ${result.total_columns} premenných. Vyberte cieľovú premennú z mapy.`, 'compareTargetAnalyzersStatus');
            } catch (error) {
                showStatus('error', `Chyba porovnania: ${error}`, 'compareTargetAnalyzersStatus');
            } finally {
                showLoading(false);
            }
        }

        function buildTargetVariableMap(result) {
            const mapDiv = document.getElementById('targetVariableMap');
            if (!result || !result.columns || !result.analyzer_results) {
                mapDiv.innerHTML = '<p style="color:#e74c3c;">Chyba: Neplatný výsledok porovnania</p>';
                return;
            }

            const columns = result.columns;
            const analyzerResults = result.analyzer_results;
            const totalMethods = analyzerResults.length;

            // Count how many methods ranked each column in top N (top 3)
            const topN = Math.min(3, Math.ceil(columns.length * 0.2)); // top 20% or 3
            const columnVotes = {};
            columns.forEach(col => { columnVotes[col] = 0; });

            analyzerResults.forEach(ar => {
                if (!ar.ranking || ar.ranking.length === 0) return;
                const topCols = ar.ranking.slice(0, topN);
                topCols.forEach(entry => {
                    if (columnVotes[entry.column_name] !== undefined) {
                        columnVotes[entry.column_name]++;
                    }
                });
            });

            let html = '<div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:8px;">';
            columns.forEach(colName => {
                const votes = columnVotes[colName];
                const votePct = totalMethods > 0 ? (votes / totalMethods * 100) : 0;
                
                const bg = votePct === 100 ? '#c8e6c9' 
                    : votePct >= 67 ? '#fff9c4'
                    : votePct >= 33 ? '#ffe0b2'
                    : '#ffcdd2';
                
                const dots = Array.from({length: totalMethods}, (_, i) => 
                    i < votes ? '\u25cf' : '\u25cb'
                ).join('');

                html += `<div onclick="selectTargetFromMap('${colName}')" style="
                    padding:12px; background:${bg}; border:2px solid #dee2e6; 
                    cursor:pointer; transition:transform 0.1s; font-size:13px;
                " onmouseover="this.style.transform='scale(1.02)'" onmouseout="this.style.transform='scale(1)'">
                    <div style="font-weight:bold; color:#cc0000; margin-bottom:4px;">${colName}</div>
                    <div style="font-size:11px; color:#495057; display:flex; justify-content:space-between; align-items:center;">
                        <span>${votes}/${totalMethods}</span>
                        <span style="font-weight:bold;">${dots}</span>
                    </div>
                </div>`;
            });
            html += '</div>';

            // Scatter plot if SMC and MI are both selected
            const smcResult = analyzerResults.find(ar => ar.method === 'smc');
            const miResult = analyzerResults.find(ar => ar.method === 'mutual_information');
            
            if (smcResult && miResult && smcResult.ranking && miResult.ranking) {
                html += '<h4 style="color:#495057;margin:25px 0 10px;border-bottom:2px solid #dee2e6;padding-bottom:8px;">Scatter plot: SMC vs Mutual Information</h4>';
                html += '<p style="font-size:12px;color:#6c757d;margin-bottom:10px;">X-os: SMC hodnota | Y-os: Suma MI hodnoty. Prejdite myšou nad bodmi pre názov premennej.</p>';
                
                // Build data arrays
                const plotData = [];
                columns.forEach(colName => {
                    const smcEntry = smcResult.ranking.find(r => r.column_name === colName);
                    const miEntry = miResult.ranking.find(r => r.column_name === colName);
                    if (smcEntry && miEntry) {
                        plotData.push({
                            name: colName,
                            smc: smcEntry.score,
                            mi: miEntry.score
                        });
                    }
                });

                if (plotData.length > 0) {
                    // Find min/max for scaling
                    const smcValues = plotData.map(d => d.smc);
                    const miValues = plotData.map(d => d.mi);
                    const smcMin = Math.min(...smcValues);
                    const smcMax = Math.max(...smcValues);
                    const miMin = Math.min(...miValues);
                    const miMax = Math.max(...miValues);

                    const width = 600;
                    const height = 400;
                    const margin = {top: 20, right: 20, bottom: 50, left: 60};
                    const plotWidth = width - margin.left - margin.right;
                    const plotHeight = height - margin.top - margin.bottom;

                    // Scale functions
                    const smcRange = smcMax - smcMin || 1;
                    const miRange = miMax - miMin || 1;
                    const scaleX = (val) => margin.left + ((val - smcMin) / smcRange) * plotWidth;
                    const scaleY = (val) => margin.top + plotHeight - ((val - miMin) / miRange) * plotHeight;

                    // Start SVG
                    html += `<div style="background:white;border:1px solid #dee2e6;padding:15px;display:inline-block;">`;
                    html += `<svg width="${width}" height="${height}" style="font-family:Segoe UI,sans-serif;">`;
                    
                    // Grid lines
                    html += `<g opacity="0.1">`;
                    for (let i = 0; i <= 5; i++) {
                        const x = margin.left + (plotWidth * i / 5);
                        const y = margin.top + (plotHeight * i / 5);
                        html += `<line x1="${x}" y1="${margin.top}" x2="${x}" y2="${margin.top + plotHeight}" stroke="#000" stroke-width="1"/>`;
                        html += `<line x1="${margin.left}" y1="${y}" x2="${margin.left + plotWidth}" y2="${y}" stroke="#000" stroke-width="1"/>`;
                    }
                    html += `</g>`;

                    // Axes
                    html += `<line x1="${margin.left}" y1="${margin.top + plotHeight}" x2="${margin.left + plotWidth}" y2="${margin.top + plotHeight}" stroke="#000" stroke-width="2"/>`;
                    html += `<line x1="${margin.left}" y1="${margin.top}" x2="${margin.left}" y2="${margin.top + plotHeight}" stroke="#000" stroke-width="2"/>`;

                    // Axis labels
                    html += `<text x="${margin.left + plotWidth/2}" y="${height - 10}" text-anchor="middle" font-size="12" fill="#495057">SMC</text>`;
                    html += `<text x="15" y="${margin.top + plotHeight/2}" text-anchor="middle" font-size="12" fill="#495057" transform="rotate(-90, 15, ${margin.top + plotHeight/2})">Σ MI</text>`;

                    // Tick labels
                    for (let i = 0; i <= 5; i++) {
                        const smcVal = smcMin + (smcRange * i / 5);
                        const miVal = miMin + (miRange * i / 5);
                        const x = margin.left + (plotWidth * i / 5);
                        const y = margin.top + plotHeight - (plotHeight * i / 5);
                        html += `<text x="${x}" y="${margin.top + plotHeight + 20}" text-anchor="middle" font-size="10" fill="#6c757d">${smcVal.toFixed(3)}</text>`;
                        html += `<text x="${margin.left - 10}" y="${y + 4}" text-anchor="end" font-size="10" fill="#6c757d">${miVal.toFixed(3)}</text>`;
                    }

                    // Data points
                    plotData.forEach((d, idx) => {
                        const cx = scaleX(d.smc);
                        const cy = scaleY(d.mi);
                        const pointId = `point_${idx}`;
                        const tooltipId = `tooltip_${idx}`;
                        
                        // Smart tooltip positioning
                        const tooltipWidth = d.name.length * 7 + 20;
                        const tooltipX = cx + 10 + tooltipWidth > width ? cx - tooltipWidth - 10 : cx + 10;
                        const tooltipY = cy - 30 < margin.top ? cy + 10 : cy - 30;
                        
                        html += `<circle id="${pointId}" cx="${cx}" cy="${cy}" r="5" fill="#cc0000" stroke="white" stroke-width="2" opacity="0.7" style="cursor:pointer;transition:all 0.2s;" onclick="selectTargetFromMap('${d.name}')" onmouseover="document.getElementById('${pointId}').setAttribute('r', '8'); document.getElementById('${pointId}').setAttribute('opacity', '1'); document.getElementById('${tooltipId}').style.display='block';" onmouseout="document.getElementById('${pointId}').setAttribute('r', '5'); document.getElementById('${pointId}').setAttribute('opacity', '0.7'); document.getElementById('${tooltipId}').style.display='none';" />`;
                        
                        // Tooltip
                        html += `<g id="${tooltipId}" style="display:none;pointer-events:none;">`;
                        html += `<rect x="${tooltipX}" y="${tooltipY}" width="${tooltipWidth}" height="25" fill="white" stroke="#cc0000" stroke-width="2" rx="3"/>`;
                        html += `<text x="${tooltipX + 10}" y="${tooltipY + 16}" font-size="11" font-weight="bold" fill="#cc0000">${d.name}</text>`;
                        html += `</g>`;
                    });

                    html += `</svg></div>`;
                    html += '<div style="margin-top:10px;font-size:12px;color:#6c757d;">Kliknite na bod pre výber premennej. Vyššie hodnoty na oboch osiach = lepší kandidát na cieľovú premennú.</div>';
                }
            }

            // Legend
            html += '<div style="margin-top:15px;font-size:12px;display:flex;gap:10px;flex-wrap:wrap;">';
            html += '<span style="background:#c8e6c9;padding:4px 10px;border:1px solid #aaa;">Všetky metódy</span>';
            html += '<span style="background:#fff9c4;padding:4px 10px;border:1px solid #aaa;">Väčšina metód (≥67%)</span>';
            html += '<span style="background:#ffe0b2;padding:4px 10px;border:1px solid #aaa;">Niektoré metódy (≥33%)</span>';
            html += '<span style="background:#ffcdd2;padding:4px 10px;border:1px solid #aaa;">Menej metód</span>';
            html += '</div>';

            mapDiv.innerHTML = html;
        }

        function selectTargetFromMap(colName) {
            const targetInput = document.getElementById('targetColumnSelect');
            targetInput.value = colName;
            
            // Visual feedback
            document.querySelectorAll('#targetVariableMap > div > div').forEach(el => {
                el.style.border = '2px solid #dee2e6';
            });
            event.target.closest('div[onclick]').style.border = '4px solid #cc0000';
            
            showStatus('info', `Vybratá premenná: ${colName}`, 'compareTargetAnalyzersStatus');
        }
        window.selectTargetFromMap = selectTargetFromMap;

        // Legacy compatibility
        function selectTargetFromAnalysis(colName, suggestedType) {
            selectTargetFromMap(colName);
        }
        window.selectTargetFromAnalysis = selectTargetFromAnalysis;

        function populateTargetAnalyzerMethods() {
            try {
                const rawAnalyzers = pipeline.getAvailableTargetAnalyzers();
                const analyzers = convertWasmResult(rawAnalyzers);
                if (!analyzers || !analyzers.length) return;

                const grid = document.getElementById('targetAnalyzerGrid');
                grid.innerHTML = '';

                analyzers.forEach(ana => {
                    const card = document.createElement('div');
                    card.className = 'selector-compare-card';
                    card.id = `target_card_${ana.name}`;

                    card.innerHTML = `
                        <div class="card-header">
                            <input type="checkbox" id="target_ana_${ana.name}" onchange="toggleTargetCard('${ana.name}')">
                            <label for="target_ana_${ana.name}">${ana.metric_name}</label>
                        </div>
                        <div class="card-desc">${ana.description}</div>
                        <div class="card-tags" style="font-size:11px;color:#6c757d;">${ana.metric_explanation}</div>
                        <button onclick="showAnalyzerDetails('${ana.name}'); event.stopPropagation();" 
                                style="margin-top:8px; padding:6px 12px; font-size:11px; background:#6c757d; color:white; border:none; cursor:pointer; border-radius:4px;">
                            Zobraziť detaily (matica, kandidáti)
                        </button>
                    `;
                    grid.appendChild(card);
                });

                window._targetAnalyzers = analyzers;
            } catch (e) {
                console.warn('Could not load target analyzers:', e);
            }
        }

        function toggleTargetCard(name) {
            const cb = document.getElementById(`target_ana_${name}`);
            const card = document.getElementById(`target_card_${name}`);
            card.classList.toggle('active', cb.checked);
        }
        window.toggleTargetCard = toggleTargetCard;

        function toggleAllAnalyzers() {
            const cards = document.querySelectorAll('#targetAnalyzerGrid .selector-compare-card');
            const allChecked = Array.from(cards).every(c => c.classList.contains('active'));
            cards.forEach(card => {
                const cb = card.querySelector('input[type="checkbox"]');
                cb.checked = !allChecked;
                card.classList.toggle('active', !allChecked);
            });
        }

        async function showAnalyzerDetails(method) {
            try {
                const data = window.rawDataString;
                const format = window.dataFormat;
                if (!data) {
                    alert('Najprv načítajte dáta');
                    return;
                }

                showLoading(true);
                const rawResult = await pipeline.analyzeTargetWith(data, format, method);
                const result = convertWasmResult(rawResult);

                // Create modal to show details
                const modal = document.getElementById('analyzerDetailsModal');
                const content = document.getElementById('analyzerDetailsContent');
                const titleEl = document.getElementById('analyzerDetailsTitle');
                
                titleEl.textContent = `${result.metric_name} - ${result.method_description}`;
                content.innerHTML = result.html;
                modal.classList.add('show');
            } catch (error) {
                alert(`Chyba pri načítaní detailov: ${error}`);
            } finally {
                showLoading(false);
            }
        }
        window.showAnalyzerDetails = showAnalyzerDetails;

        function closeAnalyzerDetailsModal() {
            document.getElementById('analyzerDetailsModal').classList.remove('show');
        }
        window.closeAnalyzerDetailsModal = closeAnalyzerDetailsModal;

        function buildColumnStatsTable(data, columns, format) {
            if (format !== 'csv') {
                document.getElementById('columnStatsContainer').innerHTML = '<p style="color:#6c757d;">Štatistický prehľad je dostupný len pre CSV formát.</p>';
                return;
            }
            const lines = data.split('\n').filter(l => l.trim());
            if (lines.length < 2) return;

            const headers = lines[0].split(',').map(h => h.trim());
            const rows = lines.slice(1).map(l => l.split(',').map(v => v.trim()));

            let html = '<table class="column-stats"><thead><tr>';
            html += '<th>Premenná</th><th>Typ</th><th>Unikátnych</th><th>Min</th><th>Max</th><th>Priemer</th>';
            html += '</tr></thead><tbody>';

            columns.forEach((col, colIdx) => {
                // Find column index in headers (might not match columns if target excluded)
                const hIdx = headers.indexOf(col);
                if (hIdx === -1) return;

                const values = rows.map(r => r[hIdx]).filter(v => v !== undefined && v !== '');
                const numValues = values.map(Number).filter(v => !isNaN(v));
                const isNumeric = numValues.length > values.length * 0.8;
                const uniqueCount = new Set(values).size;

                let min = '-', max = '-', mean = '-';
                if (isNumeric && numValues.length > 0) {
                    min = Math.min(...numValues).toFixed(2);
                    max = Math.max(...numValues).toFixed(2);
                    mean = (numValues.reduce((a,b) => a+b, 0) / numValues.length).toFixed(2);
                }

                const ratio = uniqueCount / values.length;
                let typeLabel, suggestion;
                if (!isNumeric) {
                    typeLabel = 'Kategorický';
                    suggestion = uniqueCount <= 10 ? 'Klasifikácia' : 'Kategorický';
                } else if (uniqueCount <= 10 || ratio < 0.05) {
                    typeLabel = 'Diskrétny';
                    suggestion = 'Klasifikácia';
                } else {
                    typeLabel = 'Spojitý';
                    suggestion = 'Regresia';
                }

                html += `<tr data-column="${col}" onclick="selectTargetFromStats('${col}')">`;
                html += `<td style="text-align:left;font-weight:bold;">${col}</td>`;
                html += `<td>${typeLabel}</td>`;
                html += `<td>${uniqueCount}</td>`;
                html += `<td>${min}</td>`;
                html += `<td>${max}</td>`;
                html += `<td>${mean}</td>`;
                html += '</tr>';
            });
            html += '</tbody></table>';
            document.getElementById('columnStatsContainer').innerHTML = html;
        }

        function selectTargetFromStats(colName) {
            const targetSelect = document.getElementById('targetColumnSelect');
            targetSelect.value = colName;
            highlightStatsRow(colName);
        }
        window.selectTargetFromStats = selectTargetFromStats;

        function highlightStatsRow(colName) {
            document.querySelectorAll('.column-stats tbody tr').forEach(tr => {
                tr.classList.toggle('selected-row', tr.dataset.column === colName);
            });
        }

        // ===== Feature exploration / selector comparison =====

        function populateComparisonSelectors() {
            if (!availableOptions || !availableOptions.selectors) return;
            const grid = document.getElementById('selectorCompareGrid');
            grid.innerHTML = '';

            availableOptions.selectors.forEach(sel => {
                const card = document.createElement('div');
                card.className = 'selector-compare-card';
                card.id = `compare_card_${sel.name}`;

                const tags = sel.supported_types.map(t =>
                    `<span class="card-tag">${t}</span>`
                ).join('');
                const warnTag = sel.requires_binning
                    ? '<span class="card-tag warn">Vyžaduje Binner</span>'
                    : '';

                // Build param inputs based on selector type
                let paramsHtml = '';
                const params = factory.getSelectorParams(sel.name);
                if (params && params.length > 0) {
                    params.forEach(p => {
                        let defaultVal = '';
                        let label = p;
                        if (p === 'num_features') {
                            defaultVal = '5';
                            label = 'Počet features';
                        } else if (p === 'threshold') {
                            defaultVal = sel.name === 'correlation' ? '0.95' : '0.01';
                            label = 'Prahová hodnota';
                        }
                        paramsHtml += `<div class="form-group" style="margin-bottom:8px;">
                            <label>${label} (${p}):</label>
                            <input type="number" step="any" value="${defaultVal}" id="compare_param_${sel.name}_${p}">
                        </div>`;
                    });
                }

                card.innerHTML = `
                    <div class="card-header">
                        <input type="checkbox" id="compare_sel_${sel.name}" onchange="toggleCompareCard('${sel.name}')">
                        <label for="compare_sel_${sel.name}">${sel.name}</label>
                    </div>
                    <div class="card-desc">${sel.description}</div>
                    <div class="card-tags">${tags}${warnTag}</div>
                    <div class="card-params">${paramsHtml}</div>
                `;
                grid.appendChild(card);
            });
        }

        function toggleCompareCard(name) {
            const cb = document.getElementById(`compare_sel_${name}`);
            const card = document.getElementById(`compare_card_${name}`);
            card.classList.toggle('active', cb.checked);
        }
        window.toggleCompareCard = toggleCompareCard;

        function toggleAllSelectors() {
            const cards = document.querySelectorAll('#selectorCompareGrid .selector-compare-card');
            const allChecked = Array.from(cards).every(c => c.classList.contains('active'));
            cards.forEach(card => {
                const cb = card.querySelector('input[type="checkbox"]');
                cb.checked = !allChecked;
                card.classList.toggle('active', !allChecked);
            });
        }

        // Detekcia redundancie medzi vybranými featurmi
        let previouslySelected = new Set();
        
        function attachRedundancyChecks() {
            const checkboxes = document.querySelectorAll('#userFeatureMap input[type=checkbox]');
            if (checkboxes.length === 0) return;

            // Inicializuj previouslySelected s aktuálnym stavom
            previouslySelected.clear();
            document.querySelectorAll('#userFeatureMap input[type=checkbox]:checked').forEach(cb => {
                previouslySelected.add(parseInt(cb.dataset.featureIdx));
            });

            checkboxes.forEach(checkbox => {
                checkbox.addEventListener('change', async function() {
                    // Zbierz vybrané indices
                    const selectedIndices = [];
                    const currentlySelected = new Set();
                    document.querySelectorAll('#userFeatureMap input[type=checkbox]:checked').forEach(cb => {
                        const idx = parseInt(cb.dataset.featureIdx);
                        selectedIndices.push(idx);
                        currentlySelected.add(idx);
                    });

                    if (selectedIndices.length === 0) {
                        // Skryj upozornenie ak nič nie je vybrané
                        const warningArea = document.getElementById('redundancyWarningArea');
                        if (warningArea) warningArea.style.display = 'none';
                        previouslySelected.clear();
                        return;
                    }

                    // Zisti, ktoré features boli pridané (nie default)
                    const newlyAdded = [];
                    for (let idx of currentlySelected) {
                        if (!previouslySelected.has(idx)) {
                            newlyAdded.push(idx);
                        }
                    }

                    // Ak nebola pridaná žiadna nová feature, len aktualizuj stav a skonči
                    if (newlyAdded.length === 0) {
                        previouslySelected = new Set(currentlySelected);
                        const warningArea = document.getElementById('redundancyWarningArea');
                        if (warningArea) warningArea.style.display = 'none';
                        return;
                    }

                    // Zisti cieľový stĺpec index zo result dát
                    let targetColIndex = -1;
                    if (window._lastComparisonResult && window._lastComparisonResult.target_index !== undefined) {
                        targetColIndex = window._lastComparisonResult.target_index;
                    }

                    // Zavolaj API pre detekciu redundancie s novo pridanými features
                    try {
                        // Pošli prvú novo pridanú feature ako fokus, alebo -1 ak žiadna
                        const focusFeature = newlyAdded.length > 0 ? newlyAdded[0] : -1;
                        
                        const rawResult = await pipeline.checkFeatureRedundancy(
                            window.rawDataString, 
                            window.dataFormat, 
                            selectedIndices, 
                            targetColIndex,
                            focusFeature
                        );
                        const result = convertWasmResult(rawResult);
                        displayRedundancyWarnings(result);
                        
                        // Aktualizuj stav
                        previouslySelected = new Set(currentlySelected);
                    } catch (error) {
                        console.warn('Redundancy check failed:', error);
                    }
                });
            });
        }
        window.attachRedundancyChecks = attachRedundancyChecks;

        function displayRedundancyWarnings(report) {
            let warningArea = document.getElementById('redundancyWarningArea');
            
            if (!warningArea) {
                // Vytvor warning area ak neexistuje
                const mapContainer = document.getElementById('userFeatureMap');
                if (!mapContainer) return;
                
                warningArea = document.createElement('div');
                warningArea.id = 'redundancyWarningArea';
                mapContainer.parentNode.insertBefore(warningArea, mapContainer);
            }

            if (!report.has_issues) {
                // Zobraz OK správu alebo skry warning area
                if (report.summary && report.summary.startsWith('OK:')) {
                    let html = `<div style="margin-top:12px; padding:12px; background:#e8f5e9; border-left:4px solid #4caf50; border-radius:4px;">`;
                    html += `<strong style="color:#2e7d32;">✓ ${report.summary}</strong>`;
                    html += `</div>`;
                    warningArea.innerHTML = html;
                    warningArea.style.display = 'block';
                    
                    // Skry po 3 sekundách
                    setTimeout(() => {
                        if (warningArea) warningArea.style.display = 'none';
                    }, 3000);
                } else {
                    warningArea.style.display = 'none';
                }
                return;
            }

            // Zobraz upozornenia
            let html = `<div style="margin-top:12px; padding:12px; background:#fff5e6; border-left:4px solid #ff9800; border-radius:4px;">`;
            html += `<strong style="color:#e65100;">${report.summary || 'Upozornenie na vysokú multikolinearitu:'}</strong><br>`;
            
            report.warnings.forEach(warning => {
                html += `<div style="margin-top:8px; font-size:12px; color:#495057;">`;
                
                if (warning.warning_type === 'high_correlation') {
                    // Korelačné upozornenie - lineárna závislosť
                    html += `⚠️ <strong>${warning.feature1_name}</strong> ↔ <strong>${warning.feature2_name}</strong>: `;
                    html += `lineárna korelácia <strong>${(warning.correlation * 100).toFixed(1)}%</strong>`;
                } else if (warning.warning_type === 'high_mutual_information') {
                    // NMI upozornenie - zdielaná informácia (zachytáva lineárne + nelineárne závislosti)
                    html += `⚠️ <strong>${warning.feature1_name}</strong> ↔ <strong>${warning.feature2_name}</strong>: `;
                    html += `zdieľaná informácia <strong>${(warning.correlation * 100).toFixed(1)}%</strong>`;
                    html += ` <span style="font-size:10px;color:#999;">(NMI - zachytáva aj nelineárne závislosti)</span>`;
                }
                html += `</div>`;
            });

            
            html += `</div>`;
            warningArea.innerHTML = html;
            warningArea.style.display = 'block';
        }
        window.displayRedundancyWarnings = displayRedundancyWarnings;

        async function compareSelectors() {
            try {
                const targetColumn = document.getElementById('targetColumnSelect').value;
                if (!targetColumn) {
                    showStatus('error', 'Najprv vyberte cieľovú premennú', 'compareSelectorStatus');
                    return;
                }
                if (!pipeline) {
                    showStatus('error', 'Pipeline nie je inicializovaný', 'compareSelectorStatus');
                    return;
                }
                const data = window.rawDataString;
                const format = window.dataFormat;
                if (!data) {
                    showStatus('error', 'Najprv načítajte dáta', 'compareSelectorStatus');
                    return;
                }

                // Collect selected selectors and their params
                const selectorConfigs = [];
                document.querySelectorAll('#selectorCompareGrid .selector-compare-card.active').forEach(card => {
                    const name = card.id.replace('compare_card_', '');
                    const params = [];
                    card.querySelectorAll('.card-params input').forEach(input => {
                        const paramName = input.id.replace(`compare_param_${name}_`, '');
                        if (input.value) {
                            params.push([paramName, input.value]);
                        }
                    });
                    selectorConfigs.push({ name, params });
                });

                if (selectorConfigs.length === 0) {
                    showStatus('error', 'Vyberte aspoň jeden selektor na porovnanie', 'compareSelectorStatus');
                    return;
                }

                showLoading(true);
                showStatus('info', `Porovnávam ${selectorConfigs.length} selektorov...`, 'compareSelectorStatus');

                const rawResult = await pipeline.compareSelectors(data, targetColumn, format, selectorConfigs);
                const result = convertWasmResult(rawResult);

                // Store results for training
                window._lastComparisonResult = result;

                // Open comparison in modal
                const modal = document.getElementById('dataModal');
                document.getElementById('modalTitle').textContent = `Porovnanie selektorov (cieľ: ${targetColumn})`;
                document.getElementById('modalBody').innerHTML = result.comparison_html;
                modal.classList.add('show');

                // Attach event handlers for interactive elements in comparison HTML
                const trainBtn = document.getElementById('trainFromComparisonBtn');
                if (trainBtn) trainBtn.onclick = trainFromComparison;
                const selectAllBtn = document.getElementById('featureMapSelectAll');
                if (selectAllBtn) selectAllBtn.onclick = () => document.querySelectorAll('#userFeatureMap input[type=checkbox]').forEach(c => c.checked = true);
                const deselectAllBtn = document.getElementById('featureMapDeselectAll');
                if (deselectAllBtn) deselectAllBtn.onclick = () => document.querySelectorAll('#userFeatureMap input[type=checkbox]').forEach(c => c.checked = false);

                // Attach redundancy check to all feature checkboxes
                attachRedundancyChecks();

                showStatus('success', `Porovnanie dokončené: ${selectorConfigs.length} selektorov na ${result.total_features} príznakoch. Teraz môžete natrénovať model s vybranými features.`, 'compareSelectorStatus');
            } catch (error) {
                showStatus('error', `Chyba porovnania: ${error}`, 'compareSelectorStatus');
            } finally {
                showLoading(false);
            }
        }

        // Train model with features selected by all compared selectors + user selection
        async function trainFromComparison() {
            const comparison = window._lastComparisonResult;
            if (!comparison || !comparison.selectors) {
                alert('Najprv spustite porovnanie selektorov');
                return;
            }
            if (!pipeline || !window.pipelineBuilt) {
                alert('Najprv vytvorte a nakonfigurujte pipeline (model)');
                return;
            }

            const trainRatio = window.trainTestRatio || 0.8;
            const resultsDiv = document.getElementById('comparisonTrainingResults');
            const statusSpan = document.getElementById('comparisonTrainStatus');

            // Collect user-selected features from checkboxes
            const userIndices = [];
            document.querySelectorAll('#userFeatureMap input[type=checkbox]:checked').forEach(cb => {
                userIndices.push(parseInt(cb.dataset.featureIdx));
            });
            userIndices.sort((a, b) => a - b);

            statusSpan.textContent = 'Trénujem varianty...';
            resultsDiv.innerHTML = '<p style="color:#6c757d;font-style:italic;">Prebieha tréning...</p>';

            const allResults = [];
            const featureNames = comparison.feature_names || [];

            try {
                // 1. Each selector's selection
                const selectors = Array.isArray(comparison.selectors) ? comparison.selectors : [];
                for (const sel of selectors) {
                    const selData = (sel instanceof Map) ? Object.fromEntries(sel) : sel;
                    if (selData.error) {
                        allResults.push({ name: selData.selector_name || selData.config_name, error: selData.error, indices: [], count: 0 });
                        continue;
                    }
                    const indices = selData.selected_indices || [];
                    if (indices.length === 0) {
                        allResults.push({ name: selData.selector_name, error: 'Nevybral žiadne features', indices: [], count: 0 });
                        continue;
                    }
                    try {
                        const t0 = performance.now();
                        const trainRaw = await pipeline.trainWithFeatureIndices(trainRatio, indices);
                        const trainTime = performance.now() - t0;
                        const trainResult = convertWasmResult(trainRaw);
                        allResults.push({ name: selData.selector_name, result: trainResult, indices, count: indices.length, timeMs: trainTime });
                    } catch (e) {
                        allResults.push({ name: selData.selector_name, error: String(e), indices, count: indices.length });
                    }
                }

                // 2. Baseline - all features, no selection
                try {
                    const t0 = performance.now();
                    const baseRaw = await pipeline.trainWithSplit(trainRatio);
                    const baseTime = performance.now() - t0;
                    const baseResult = convertWasmResult(baseRaw);
                    allResults.push({ name: 'Bez selekcie (všetky features)', result: baseResult, indices: null, count: comparison.total_features, timeMs: baseTime });
                } catch (e) {
                    allResults.push({ name: 'Bez selekcie (všetky features)', error: String(e), indices: null, count: comparison.total_features });
                }

                // 3. User's custom selection
                if (userIndices.length > 0) {
                    try {
                        const t0 = performance.now();
                        const userRaw = await pipeline.trainWithFeatureIndices(trainRatio, userIndices);
                        const userTime = performance.now() - t0;
                        const userResult = convertWasmResult(userRaw);
                        allResults.push({ name: 'Vlastný výber používateľa', result: userResult, indices: userIndices, count: userIndices.length, timeMs: userTime, isUser: true });
                    } catch (e) {
                        allResults.push({ name: 'Vlastný výber používateľa', error: String(e), indices: userIndices, count: userIndices.length, isUser: true });
                    }
                }

                // Render results
                renderTrainingComparison(allResults, comparison.total_features, featureNames, resultsDiv);
                statusSpan.textContent = `Hotovo – ${allResults.length} variantov natrénovaných`;
                document.getElementById('inspectProcessedBtn').disabled = false;
            } catch (error) {
                statusSpan.textContent = `Chyba: ${error}`;
                resultsDiv.innerHTML = `<p style="color:#e74c3c;">Chyba pri trénovaní: ${error}</p>`;
            }
        }

        // Legacy: Train model with features selected by all compared selectors + baseline
        async function trainAllSelectors() {
            trainFromComparison();
        }

        // Global storage for comparison results
        let globalComparisonResults = {
            allResults: [],
            totalFeatures: 0,
            featureNames: [],
            isClassification: false
        };

        // Render training comparison table
        function renderTrainingComparison(allResults, totalFeatures, featureNames, targetDiv) {
            const resultsDiv = targetDiv || document.getElementById('selectorTrainingResults');
            
            // Store globally for embedded comparison
            globalComparisonResults = {
                allResults: allResults,
                totalFeatures: totalFeatures,
                featureNames: featureNames,
                isClassification: false // will be set below
            };
            
            // Determine if classification or regression from first successful result
            const firstSuccess = allResults.find(r => r.result);
            if (!firstSuccess) {
                // All failed - show errors
                let errHtml = '<h3 style="margin-top:20px;margin-bottom:10px;color:#e74c3c;">Všetky pokusy o trénovanie zlyhali</h3>';
                errHtml += '<ul style="color:#e74c3c;">';
                allResults.forEach(r => {
                    errHtml += `<li><strong>${r.name}</strong>: ${r.error || 'Neznáma chyba'}</li>`;
                });
                errHtml += '</ul>';
                resultsDiv.innerHTML = errHtml;
                return;
            }
            const isClassification = firstSuccess.result.evaluation_mode === 'classification';
            globalComparisonResults.isClassification = isClassification;

            let html = '<h3 style="margin-top:20px;margin-bottom:10px;color:#cc0000;">Porovnanie výsledkov tréningu</h3>';
            html += '<div style="overflow-x:auto;"><table style="width:100%;border-collapse:collapse;font-size:12px;">';
            html += '<thead><tr>';
            html += '<th style="padding:10px 6px;border:1px solid #dee2e6;background:#cc0000;color:white;text-align:left;font-size:11px;">Metóda</th>';
            html += '<th style="padding:10px 6px;border:1px solid #dee2e6;background:#cc0000;color:white;text-align:center;font-size:11px;">Features</th>';
            
            if (isClassification) {
                html += '<th style="padding:10px 6px;border:1px solid #dee2e6;background:#cc0000;color:white;text-align:center;font-size:11px;" title="Accuracy">ACC</th>';
                html += '<th style="padding:10px 6px;border:1px solid #dee2e6;background:#cc0000;color:white;text-align:center;font-size:11px;" title="F1 Score">F1</th>';
                html += '<th style="padding:10px 6px;border:1px solid #dee2e6;background:#cc0000;color:white;text-align:center;font-size:11px;" title="Precision">PREC</th>';
                html += '<th style="padding:10px 6px;border:1px solid #dee2e6;background:#cc0000;color:white;text-align:center;font-size:11px;" title="Recall/Sensitivity">REC</th>';
                html += '<th style="padding:10px 6px;border:1px solid #dee2e6;background:#cc0000;color:white;text-align:center;font-size:11px;" title="Specificity">SPEC</th>';
                html += '<th style="padding:10px 6px;border:1px solid #dee2e6;background:#cc0000;color:white;text-align:center;font-size:11px;" title="False Positives">FP</th>';
                html += '<th style="padding:10px 6px;border:1px solid #dee2e6;background:#cc0000;color:white;text-align:center;font-size:11px;" title="False Negatives">FN</th>';
                html += '<th style="padding:10px 6px;border:1px solid #dee2e6;background:#cc0000;color:white;text-align:center;font-size:11px;" title="Matthews Correlation Coeff">MCC</th>';
            } else {
                html += '<th style="padding:10px 6px;border:1px solid #dee2e6;background:#cc0000;color:white;text-align:center;font-size:11px;" title="R-squared">R²</th>';
                html += '<th style="padding:10px 6px;border:1px solid #dee2e6;background:#cc0000;color:white;text-align:center;font-size:11px;" title="Root Mean Squared Error">RMSE</th>';
                html += '<th style="padding:10px 6px;border:1px solid #dee2e6;background:#cc0000;color:white;text-align:center;font-size:11px;" title="Mean Absolute Error">MAE</th>';
                html += '<th style="padding:10px 6px;border:1px solid #dee2e6;background:#cc0000;color:white;text-align:center;font-size:11px;" title="Mean Absolute Percentage Error">MAPE</th>';
                html += '<th style="padding:10px 6px;border:1px solid #dee2e6;background:#cc0000;color:white;text-align:center;font-size:11px;" title="Median Absolute Error">MedAE</th>';
                html += '<th style="padding:10px 6px;border:1px solid #dee2e6;background:#cc0000;color:white;text-align:center;font-size:11px;" title="Pearsonova korelácia predikcie">CORR</th>';
            }
            html += '<th style="padding:10px 6px;border:1px solid #dee2e6;background:#cc0000;color:white;text-align:center;font-size:11px;">Čas (ms)</th>';
            html += '</tr></thead><tbody>';

            // Find best values for highlighting
            let bestMetric = -Infinity;
            allResults.forEach(r => {
                if (!r.result) return;
                const val = isClassification ? r.result.accuracy : r.result.r2_score;
                if (val > bestMetric) bestMetric = val;
            });

            allResults.forEach((r, idx) => {
                const isBaseline = r.indices === null;
                const isUser = r.isUser === true;
                const isEmbedded = r.isEmbedded === true;
                const isBest = r.result && ((isClassification ? r.result.accuracy : r.result.r2_score) === bestMetric);
                const bg = isBest ? 'background:#ffe4e1;' : isEmbedded ? 'background:#fff9e6;' : isUser ? 'background:#fff0f0;' : (idx % 2 === 0 ? 'background:#f8f9fa;' : '');
                
                html += `<tr style="${bg}">`;
                html += `<td style="padding:6px;border:1px solid #dee2e6;font-weight:${isBaseline ? 'normal' : 'bold'};font-size:12px;${isUser ? 'color:#cc0000;' : ''}${isEmbedded ? 'color:#ff8c00;' : ''}">${isEmbedded ? '🔧 ' : ''}${r.name}${isBest ? ' ⭐ best' : ''}</td>`;
                html += `<td style="padding:6px;border:1px solid #dee2e6;text-align:center;font-size:12px;">${r.count}/${totalFeatures}</td>`;

                if (r.error) {
                    const colSpan = isClassification ? 8 : 6;
                    html += `<td colspan="${colSpan}" style="padding:6px;border:1px solid #dee2e6;color:#e74c3c;text-align:center;font-size:11px;">${r.error}</td>`;
                } else if (r.result) {
                    if (isClassification) {
                        html += `<td style="padding:6px;border:1px solid #dee2e6;text-align:center;font-weight:bold;color:#cc0000;font-size:12px;">${(r.result.accuracy * 100).toFixed(1)}%</td>`;
                        html += `<td style="padding:6px;border:1px solid #dee2e6;text-align:center;font-size:12px;">${r.result.f1_score.toFixed(3)}</td>`;
                        html += `<td style="padding:6px;border:1px solid #dee2e6;text-align:center;font-size:12px;">${r.result.precision.toFixed(3)}</td>`;
                        html += `<td style="padding:6px;border:1px solid #dee2e6;text-align:center;font-size:12px;">${r.result.recall.toFixed(3)}</td>`;
                        html += `<td style="padding:6px;border:1px solid #dee2e6;text-align:center;font-size:12px;">${r.result.specificity.toFixed(3)}</td>`;
                        html += `<td style="padding:6px;border:1px solid #dee2e6;text-align:center;font-size:12px;">${Math.round(r.result.false_positives)}</td>`;
                        html += `<td style="padding:6px;border:1px solid #dee2e6;text-align:center;font-size:12px;">${Math.round(r.result.false_negatives)}</td>`;
                        html += `<td style="padding:6px;border:1px solid #dee2e6;text-align:center;font-size:12px;">${r.result.mcc.toFixed(3)}</td>`;
                    } else {
                        html += `<td style="padding:6px;border:1px solid #dee2e6;text-align:center;font-weight:bold;color:#cc0000;font-size:12px;">${r.result.r2_score.toFixed(4)}</td>`;
                        html += `<td style="padding:6px;border:1px solid #dee2e6;text-align:center;font-size:12px;">${r.result.rmse.toFixed(3)}</td>`;
                        html += `<td style="padding:6px;border:1px solid #dee2e6;text-align:center;font-size:12px;">${r.result.mae.toFixed(3)}</td>`;
                        html += `<td style="padding:6px;border:1px solid #dee2e6;text-align:center;font-size:12px;">${r.result.mape ? r.result.mape.toFixed(2) + '%' : 'N/A'}</td>`;
                        html += `<td style="padding:6px;border:1px solid #dee2e6;text-align:center;font-size:12px;">${r.result.median_absolute_error.toFixed(3)}</td>`;
                        html += `<td style="padding:6px;border:1px solid #dee2e6;text-align:center;font-size:12px;">${r.result.pearson_correlation.toFixed(3)}</td>`;
                    }
                    const timeStr = r.timeMs ? `${r.timeMs.toFixed(0)}` : '-';
                    html += `<td style="padding:6px;border:1px solid #dee2e6;text-align:center;color:#6c757d;font-size:12px;">${timeStr}</td>`;
                }
                html += '</tr>';
            });

            html += '</tbody></table></div>';
            
            // Add legend for abbreviations
            html += '<div style="margin-top:12px;padding:12px;background:#f8f9fa;border:1px solid #dee2e6;border-radius:4px;font-size:11px;color:#495057;">';
            if (isClassification) {
                html += '<strong>Metriky klasifikácie:</strong><br>';
                html += '• ACC = Accuracy | F1 = F1 Score | PREC = Precision | REC = Recall/Sensitivity | SPEC = Specificity<br>';
                html += '• FP = počet falošne pozitívnych prípadov | FN = počet falošne negatívnych prípadov<br>';
                html += '• MCC = Matthews Correlation Coefficient (vhodnejší ako accuracy pre imbalancované dáta)<br>';
            } else {
                html += '<strong>Metriky regresie:</strong><br>';
                html += '• R² = Koeficient determinácie (0-1, vyššia = lepšia) | RMSE = Root Mean Squared Error<br>';
                html += '• MAE = Mean Absolute Error | MAPE = Mean Absolute Percentage Error<br>';
                html += '• MedAE = Median Absolute Error | CORR = Pearsonova korelácia (sklon linearity)<br>';
            }
            html += '</div>';

            // Show which features each selector picked
            html += '<details style="margin-top:15px;border:1px solid #dee2e6;">';
            html += '<summary style="padding:12px;background:#f8f9fa;cursor:pointer;font-weight:600;color:#cc0000;">Vybrané features jednotlivými variantmi</summary>';
            html += '<div style="padding:15px;">';
            allResults.forEach(r => {
                if (r.indices === null) return; // skip baseline
                const names = r.indices && featureNames.length > 0 
                    ? r.indices.map(i => featureNames[i] || `[${i}]`).join(', ')
                    : (r.indices || []).join(', ');
                const style = r.isUser ? 'color:#cc0000;' : '';
                html += `<p style="${style}"><strong>${r.name}</strong> (${r.count} features): ${names || 'N/A'}</p>`;
            });
            html += '</div></details>';

            // Add button to compare with embedded methods
            html += '<div style="margin-top:20px;padding:15px;background:#fff0f0;border:1px solid #cc0000;border-radius:4px;">';
            html += '<h4 style="margin:0 0 8px 0;color:#cc0000;">Porovnanie s Embedded metódami</h4>';
            html += '<p style="margin:0 0 12px 0;font-size:12px;color:#495057;">Embedded metódy vyberajú features priamo počas trénovania modelu (koeficienty, feature importance). Porovnajte ich výsledky s filter metódami použitými vyššie.</p>';
            html += '<button id="compareEmbeddedBtn" style="background:#cc0000;color:white;border:none;padding:10px 20px;cursor:pointer;font-size:14px;font-weight:bold;border-radius:4px;">Porovnať s Embedded metódami</button>';
            html += ' <span id="embeddedComparisonStatus" style="margin-left:12px;font-size:0.9em;color:#6c757d;"></span>';
            html += '<div id="embeddedComparisonResults" style="margin-top:15px;"></div>';
            html += '</div>';

            resultsDiv.innerHTML = html;

            // Attach event handler for embedded methods comparison
            const embeddedBtn = document.getElementById('compareEmbeddedBtn');
            if (embeddedBtn) {
                embeddedBtn.onclick = async () => {
                    await compareWithEmbeddedMethods(allResults, totalFeatures, featureNames, isClassification);
                };
            }
        }

        async function compareWithEmbeddedMethods(allResults, totalFeatures, featureNames, isClassification) {
            const statusSpan = document.getElementById('embeddedComparisonStatus');
            const resultsDiv = document.getElementById('embeddedComparisonResults');
            const btn = document.getElementById('compareEmbeddedBtn');

            try {
                btn.disabled = true;
                statusSpan.textContent = 'Analyzujem features pomocou embedded metódy...';
                statusSpan.style.color = '#28a745';

                // Calculate average number of features from filter methods (exclude baseline and user selection)
                const filterResults = allResults.filter(r => r.indices && !r.isUser);
                const avgFeatures = filterResults.length > 0
                    ? Math.round(filterResults.reduce((sum, r) => sum + r.count, 0) / filterResults.length)
                    : 5; // default

                // Get training split ratio from UI
                const trainRatio = parseFloat(document.getElementById('trainTestSplit').value) / 100;

                // Call embedded feature ranking
                const rankingResult = await pipeline.getEmbeddedFeatureRanking(trainRatio, avgFeatures);
                const ranking = convertWasmResult(rankingResult);

                statusSpan.textContent = `Embedded metóda vybrala ${ranking.selected_indices.length} features, trénovanie...`;

                // Train model with embedded-selected features
                const t0 = performance.now();
                const embeddedTrainResult = await pipeline.trainWithFeatureIndices(
                    trainRatio,
                    ranking.selected_indices
                );
                const trainTime = performance.now() - t0;
                const embeddedResult = convertWasmResult(embeddedTrainResult);

                statusSpan.textContent = 'Hotovo!';
                statusSpan.style.color = '#28a745';
                btn.disabled = false;

                // Add embedded result to global results
                const embeddedEntry = {
                    name: ranking.method,
                    result: embeddedResult,
                    indices: ranking.selected_indices,
                    count: ranking.selected_indices.length,
                    timeMs: trainTime,
                    isEmbedded: true
                };

                // Check if embedded result already exists, replace it
                const existingIdx = globalComparisonResults.allResults.findIndex(r => r.isEmbedded);
                if (existingIdx >= 0) {
                    globalComparisonResults.allResults[existingIdx] = embeddedEntry;
                } else {
                    globalComparisonResults.allResults.push(embeddedEntry);
                }

                // Re-render the entire comparison table with embedded results included
                const comparisonResultsDiv = document.getElementById('comparisonTrainingResults');
                renderTrainingComparison(
                    globalComparisonResults.allResults,
                    globalComparisonResults.totalFeatures,
                    globalComparisonResults.featureNames,
                    comparisonResultsDiv
                );

                // Show success message in embedded section
                resultsDiv.innerHTML = '<p style="color:#28a745;font-weight:bold;">✓ Embedded metóda pridaná do tabuľky porovnania vyššie</p>';

            } catch (error) {
                statusSpan.textContent = `Chyba: ${error}`;
                statusSpan.style.color = '#e74c3c';
                resultsDiv.innerHTML = `<p style="color:#e74c3c;">Chyba pri embedded porovnaní: ${error}</p>`;
                btn.disabled = false;
                console.error('Embedded comparison error:', error);
            }
        }

        function showStatus(type, message, elementId) {
            const statusDiv = document.getElementById(elementId);
            statusDiv.className = `status ${type}`;
            statusDiv.textContent = message;
        }

        function showLoading(show) {
            document.getElementById('loadingOverlay').className = show ? 'show' : '';
        }

        // Data Inspection Functions
        async function inspectData() {
            try {
                const result = await pipeline.inspectData(10);
                const data = convertWasmResult(result);
                showDataModal('Nahraté dáta', data);
            } catch (error) {
                console.error('inspectData error:', error);
                alert('Error: ' + error);
            }
        }

        async function inspectProcessedData() {
            try {
                const result = await pipeline.inspectProcessedData(10);
                const data = convertWasmResult(result);
                showDataModal('Spracované dáta (po výbere a preprocessingu)', data);
            } catch (error) {
                alert('Error: ' + error);
            }
        }

        function showDataModal(title, data) {
            if (!data || !data.feature_names || !data.rows) {
                alert('Chyba: Neplatný formát dát z WASM. Skontrolujte konzolu pre detaily.');
                console.error('Invalid data:', data);
                return;
            }
            
            const modal = document.getElementById('dataModal');
            document.getElementById('modalTitle').textContent = title;
            
            let html = `
                <div class="feature-info">
                    <p><strong>Počet riadkov:</strong> ${data.total_rows} (zobrazených prvých ${data.shown_rows})</p>
                    <p><strong>Počet stĺpcov:</strong> ${data.total_cols}</p>
                    ${data.selected_indices ? `<p><strong>Vybrané indexy:</strong> ${JSON.stringify(data.selected_indices)}</p>` : ''}
                    ${data.preprocessing_applied ? `<p><strong>Preprocessing:</strong> Aplikovaný</p>` : ''}
                </div>

                <table class="data-table">
                    <thead>
                        <tr>
                            <th>#</th>
                            ${data.feature_names.map(name => `<th>${name}</th>`).join('')}
                            <th>${data.target_name}</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${data.rows.map((row, idx) => `
                            <tr>
                                <td><strong>${idx + 1}</strong></td>
                                ${row.map(val => `<td>${typeof val === 'number' ? val.toFixed(4) : val}</td>`).join('')}
                            </tr>
                        `).join('')}
                    </tbody>
                </table>

                ${data.shown_rows < data.total_rows ? 
                    `<p style="margin-top: 15px; color: #6c757d; font-style: italic;">
                        ... a ďalších ${data.total_rows - data.shown_rows} riadkov
                    </p>` : ''}
            `;

            document.getElementById('modalBody').innerHTML = html;
            modal.classList.add('show');
        }

        function closeModal() {
            document.getElementById('dataModal').classList.remove('show');
        }

        // Close modal on outside click
        window.onclick = function(event) {
            const modal = document.getElementById('dataModal');
            if (event.target === modal) {
                closeModal();
            }
            const editorModal = document.getElementById('dataEditorModal');
            if (event.target === editorModal) {
                closeDataEditor();
            }
        }

        // ======================================================================
        // Data Editor Functions
        // ======================================================================

        // Stores the current working CSV data in the editor
        let editorCurrentCSV = null;

        function openDataEditor() {
            if (!window.rawDataString || window.dataFormat !== 'csv') {
                alert('Editor dát je dostupný len pre CSV formát. Najprv načítajte CSV dáta.');
                return;
            }

            editorCurrentCSV = window.rawDataString;
            const modal = document.getElementById('dataEditorModal');
            modal.classList.add('show');

            // Populate processor select
            populateEditorProcessors();

            // Render the table
            renderEditorTable();
        }

        function closeDataEditor() {
            document.getElementById('dataEditorModal').classList.remove('show');
        }

        function editorApplyAndClose() {
            if (editorCurrentCSV) {
                // Update the raw data
                window.rawDataString = editorCurrentCSV;

                // Update text area if visible
                const textArea = document.getElementById('dataInput');
                if (textArea) {
                    textArea.value = editorCurrentCSV;
                }

                // Re-parse data with updated text
                reparseAfterEdit();
            }
            closeDataEditor();
        }

        async function reparseAfterEdit() {
            try {
                const format = window.dataFormat;
                const data = window.rawDataString;

                dataLoader = new WasmDataLoaderClass(format);
                const columns = await dataLoader.getAvailableColumns(data);
                window.parsedColumns = columns;

                const targetSelect = document.getElementById('targetColumnSelect');
                const prevTarget = targetSelect.value;
                targetSelect.innerHTML = '';
                columns.forEach(col => {
                    const opt = document.createElement('option');
                    opt.value = col;
                    opt.textContent = col;
                    targetSelect.appendChild(opt);
                });
                // Restore previous target if still exists
                if (columns.includes(prevTarget)) {
                    targetSelect.value = prevTarget;
                }

                buildColumnStatsTable(data, columns, format);

                showStatus('success', `Dáta aktualizované: ${columns.length} stĺpcov.`, 'parseStatus');
            } catch (error) {
                showStatus('error', `Chyba pri aktualizácii: ${error}`, 'parseStatus');
            }
        }

        function populateEditorProcessors() {
            const select = document.getElementById('editorProcessorSelect');
            select.innerHTML = '<option value="">-- Vyberte procesor --</option>';
            if (availableOptions && availableOptions.processors) {
                availableOptions.processors.forEach(p => {
                    const opt = document.createElement('option');
                    opt.value = p.name;
                    opt.textContent = `${p.name} - ${p.description}`;
                    select.appendChild(opt);
                });
            }
            // Clear params
            document.getElementById('editorProcessorParams').innerHTML = '';
        }

        function updateEditorProcessorParams(processorName) {
            const paramsDiv = document.getElementById('editorProcessorParams');
            paramsDiv.innerHTML = '';

            if (!processorName) return;

            const paramDefs = factory.getProcessorParamDefinitions(processorName);
            if (!paramDefs || paramDefs.length === 0) return;

            paramDefs.forEach(param => {
                const item = document.createElement('div');
                item.className = 'param-item';

                const label = document.createElement('label');
                label.textContent = param.description + ':';
                item.appendChild(label);

                if (param.options && param.options.length > 0) {
                    const sel = document.createElement('select');
                    sel.id = `editor_param_${param.name}`;
                    param.options.forEach(opt => {
                        const o = document.createElement('option');
                        o.value = opt;
                        o.textContent = opt;
                        if (opt === param.default_value) o.selected = true;
                        sel.appendChild(o);
                    });
                    item.appendChild(sel);
                } else {
                    const input = document.createElement('input');
                    input.type = param.param_type === 'number' ? 'number' : 'text';
                    input.value = param.default_value;
                    input.id = `editor_param_${param.name}`;
                    if (param.min !== null && param.min !== undefined) input.min = param.min;
                    if (param.max !== null && param.max !== undefined) input.max = param.max;
                    item.appendChild(input);
                }

                paramsDiv.appendChild(item);
            });
        }

        function renderEditorTable() {
            const container = document.getElementById('editorTableContainer');
            if (!editorCurrentCSV) {
                container.innerHTML = '<p style="padding: 30px; color: #6c757d; text-align: center;">Žiadne dáta</p>';
                return;
            }

            try {
                const rawResult = pipeline.getEditableData(editorCurrentCSV, 'csv');
                const result = convertWasmResult(rawResult);
                if (!result || !result.headers || !result.rows) {
                    container.innerHTML = '<p style="padding: 30px; color: #dc3545; text-align: center;">Chyba pri spracovaní dát</p>';
                    return;
                }
                const headers = result.headers;
                const rows = result.rows;

                // Update column select  
                const colSelect = document.getElementById('editorColumnSelect');
                const prevCol = colSelect.value;
                colSelect.innerHTML = '';
                headers.forEach(h => {
                    const opt = document.createElement('option');
                    opt.value = h;
                    opt.textContent = h;
                    colSelect.appendChild(opt);
                });
                if (headers.includes(prevCol)) {
                    colSelect.value = prevCol;
                }

                // Build table - klikateľné hlavičky stĺpcov
                let html = '<table class="editor-table"><thead><tr>';
                html += '<th style="width:40px;">#</th>';
                headers.forEach((h, idx) => {
                    const escapedH = h.replace(/'/g, "\\'");
                    const isSelected = colSelect.value === h;
                    html += `<th class="col-header${isSelected ? ' selected-col' : ''}" 
                                onclick="editorSelectColumn('${escapedH}')" 
                                title="Kliknite pre výber stĺpca">${h}</th>`;
                });
                html += '</tr></thead><tbody>';

                const maxShow = Math.min(rows.length, 200);
                const selectedCol = colSelect.value;
                for (let i = 0; i < maxShow; i++) {
                    html += '<tr>';
                    html += `<td class="row-num">${i + 1}</td>`;
                    const row = rows[i];
                    headers.forEach((h, colIdx) => {
                        const val = row[colIdx] || '';
                        const isSelectedCol = h === selectedCol;
                        html += `<td class="editable${isSelectedCol ? ' selected-col-cell' : ''}" ondblclick="editorEditCell(this, ${i}, '${h.replace(/'/g, "\\'")}')">
                            ${val}
                        </td>`;
                    });
                    html += '</tr>';
                }

                html += '</tbody></table>';

                if (rows.length > maxShow) {
                    html += `<p style="padding: 10px; color: #6c757d; text-align: center; font-style: italic;">
                        Zobrazených ${maxShow} z ${rows.length} riadkov
                    </p>`;
                }

                container.innerHTML = html;
                updateEditorStatus(`${headers.length} stĺpcov, ${rows.length} riadkov`);
            } catch (error) {
                container.innerHTML = `<p style="padding: 30px; color: #e74c3c; text-align: center;">Chyba: ${error}</p>`;
            }
        }

        function editorSelectColumn(colName) {
            const colSelect = document.getElementById('editorColumnSelect');
            colSelect.value = colName;
            // Zvýrazni vybraný stĺpec v tabuľke
            document.querySelectorAll('.col-header').forEach(th => {
                th.classList.toggle('selected-col', th.textContent.trim() === colName);
            });
            document.querySelectorAll('.editor-table td.editable').forEach(td => {
                td.classList.remove('selected-col-cell');
            });
            // Zvýrazni bunkám vybraného stĺpca
            const headers = Array.from(document.querySelectorAll('.col-header'));
            const colIdx = headers.findIndex(th => th.textContent.trim() === colName);
            if (colIdx >= 0) {
                document.querySelectorAll('.editor-table tbody tr').forEach(tr => {
                    const tds = tr.querySelectorAll('td.editable');
                    if (tds[colIdx]) {
                        tds[colIdx].classList.add('selected-col-cell');
                    }
                });
            }
            // Zobraziť panel procesorov a aktualizovať label
            document.getElementById('editorProcessorPanel').style.display = 'flex';
            document.getElementById('editorSelectedColLabel').textContent = `Stĺpec: ${colName}`;
            updateEditorStatus(`Vybraný stĺpec: ${colName}`);
        }
        window.editorSelectColumn = editorSelectColumn;

        window.editorEditCell = editorEditCell;

        function editorEditCell(td, rowIdx, colName) {
            // Already editing
            if (td.querySelector('input')) return;

            const currentValue = td.textContent.trim();
            const input = document.createElement('input');
            input.type = 'text';
            input.value = currentValue;
            td.textContent = '';
            td.appendChild(input);
            input.focus();
            input.select();

            const finishEdit = async () => {
                const newValue = input.value.trim();
                if (newValue !== currentValue) {
                    try {
                        const rawResult = pipeline.setCellValue(editorCurrentCSV, rowIdx, colName, newValue);
                        const result = convertWasmResult(rawResult);
                        editorCurrentCSV = result.csv;
                        td.textContent = newValue;
                        updateEditorStatus(`Bunka [${rowIdx + 1}, ${colName}] zmenená`);
                    } catch (error) {
                        td.textContent = currentValue;
                        updateEditorStatus(`Chyba: ${error}`);
                    }
                } else {
                    td.textContent = currentValue;
                }
            };

            input.onblur = finishEdit;
            input.onkeydown = (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    input.blur();
                }
                if (e.key === 'Escape') {
                    td.textContent = currentValue;
                }
            };
        }

        async function editorApplyProcessor() {
            const colName = document.getElementById('editorColumnSelect').value;
            const processorType = document.getElementById('editorProcessorSelect').value;

            if (!colName) {
                updateEditorStatus('Vyberte stĺpec');
                return;
            }
            if (!processorType) {
                updateEditorStatus('Vyberte procesor');
                return;
            }

            try {
                // Collect params - VŽDY zaradiť parametre (aj s default hodnotami)
                const params = [];
                const paramDefs = factory.getProcessorParamDefinitions(processorType);
                if (paramDefs && paramDefs.length > 0) {
                    paramDefs.forEach(param => {
                        const input = document.getElementById(`editor_param_${param.name}`);
                        if (input) {
                            // Zaradiť vždy, aj keď je prázdne (bude sa používať default)
                            params.push([param.name, input.value || param.default_value || '']);
                        }
                    });
                }

                const rawResult = pipeline.applyProcessorToColumn(
                    editorCurrentCSV,
                    colName,
                    processorType,
                    params.length > 0 ? params : null
                );
                const result = convertWasmResult(rawResult);

                editorCurrentCSV = result.csv;
                renderEditorTable();
                updateEditorStatus(`Procesor "${processorType}" aplikovaný na stĺpec "${colName}" (${result.rows_affected} riadkov)`);
            } catch (error) {
                updateEditorStatus(`Chyba: ${error}`);
            }
        }

        async function editorDeleteColumn() {
            const colName = document.getElementById('editorColumnSelect').value;
            if (!colName) {
                updateEditorStatus('Vyberte stĺpec na vymazanie');
                return;
            }

            if (!confirm(`Naozaj chcete vymazať stĺpec "${colName}"?`)) return;

            try {
                const rawResult = pipeline.deleteColumn(editorCurrentCSV, colName);
                const result = convertWasmResult(rawResult);
                editorCurrentCSV = result.csv;
                renderEditorTable();
                updateEditorStatus(`Stĺpec "${colName}" vymazaný, zostáva ${result.remaining_columns} stĺpcov`);
            } catch (error) {
                updateEditorStatus(`Chyba: ${error}`);
            }
        }

        async function editorReplaceAll() {
            const colName = document.getElementById('editorColumnSelect').value;
            const searchVal = document.getElementById('editorSearchValue').value;
            const replaceVal = document.getElementById('editorReplaceValue').value;

            if (!colName) {
                updateEditorStatus('Vyberte stĺpec');
                return;
            }
            if (searchVal === '') {
                updateEditorStatus('Zadajte hodnotu na vyhľadanie');
                return;
            }

            try {
                const rawResult = pipeline.replaceAllInColumn(editorCurrentCSV, colName, searchVal, replaceVal);
                const result = convertWasmResult(rawResult);
                editorCurrentCSV = result.csv;
                renderEditorTable();
                updateEditorStatus(`Nahradených ${result.replaced_count} výskytov "${searchVal}" → "${replaceVal}" v stĺpci "${colName}"`);
            } catch (error) {
                updateEditorStatus(`Chyba: ${error}`);
            }
        }

        function updateEditorStatus(text) {
            document.getElementById('editorStatusText').textContent = text;
        }

        initApp();
    </script>

    <!-- Data Inspection Modal -->
    <div id="dataModal" class="modal">
        <div class="modal-content">
            <button class="modal-close" onclick="closeModal()">&times;</button>
            <h2 id="modalTitle" style="color: #cc0000; margin-bottom: 20px;"></h2>
            <div id="modalBody"></div>
        </div>
    </div>

    <!-- Analyzer Details Modal -->
    <div id="analyzerDetailsModal" class="editor-modal">
        <div class="editor-modal-content" style="max-width: 1200px;">
            <div class="editor-header">
                <h2 id="analyzerDetailsTitle">Detaily analyzera</h2>
                <button onclick="closeAnalyzerDetailsModal()" style="background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.5); color: white; padding: 8px 16px; font-size: 1em;">&times; Zavrieť</button>
            </div>
            <div id="analyzerDetailsContent" style="padding: 20px; overflow-y: auto; max-height: calc(90vh - 100px);">
                <!-- Dynamicky generovaný obsah -->
            </div>
        </div>
    </div>

    <!-- Data Editor Modal -->
    <div id="dataEditorModal" class="editor-modal">
        <div class="editor-modal-content">
            <div class="editor-header">
                <h2>Editor dát</h2>
                <span style="opacity: 0.8; font-size: 0.85em;">Kliknite na hlavičku stĺpca pre výber | Dvojklik na bunku pre úpravu</span>
                <button onclick="closeDataEditor()" style="background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.5); color: white; padding: 8px 16px; font-size: 1em;">&times; Zavrieť</button>
            </div>

            <!-- Skrytý select pre interné sledovanie vybraného stĺpca -->
            <select id="editorColumnSelect" style="display:none;"></select>

            <!-- Procesor panel - zobrazí sa po kliknutí na stĺpec -->
            <div id="editorProcessorPanel" class="editor-toolbar" style="display: none;">
                <div class="toolbar-group">
                    <label><strong id="editorSelectedColLabel">--</strong></label>
                </div>
                <div class="toolbar-group">
                    <label>Procesor:</label>
                    <select id="editorProcessorSelect" onchange="updateEditorProcessorParams(this.value)"></select>
                </div>
                <div id="editorProcessorParams" class="editor-proc-params"></div>
                <button id="editorApplyProcessorBtn" onclick="editorApplyProcessor()" style="background: #27ae60;">Aplikovať</button>
                <button id="editorDeleteColumnBtn" onclick="editorDeleteColumn()" style="background: #e74c3c;">Vymazať stĺpec</button>

                <div style="flex: 1;"></div>

                <!-- Replace All -->
                <div class="toolbar-group">
                    <label>Nájsť:</label>
                    <input type="text" id="editorSearchValue" placeholder="hodnota" style="min-width: 80px;">
                </div>
                <div class="toolbar-group">
                    <label>Nahradiť:</label>
                    <input type="text" id="editorReplaceValue" placeholder="nová hodnota" style="min-width: 80px;">
                </div>
                <button onclick="editorReplaceAll()">Nahradiť v stĺpci</button>
            </div>

            <div class="editor-body" id="editorTableContainer">
                <p style="padding: 30px; color: #6c757d; text-align: center;">Načítavanie dát...</p>
            </div>

            <div class="editor-footer">
                <span class="status-text" id="editorStatusText">Kliknite na hlavičku stĺpca pre výber</span>
                <div>
                    <button onclick="editorApplyAndClose()" style="background: #27ae60;">Použiť zmeny a zavrieť</button>
                    <button onclick="closeDataEditor()" class="btn-secondary">Zrušiť</button>
                </div>
            </div>
        </div>
    </div>

</body>
</html>