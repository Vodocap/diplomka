<!DOCTYPE html>
<html lang="sk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <base href="./">
    <title>ML Pipeline - WASM App</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #2c3e50;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 0px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        header {
            background: #3498db;
            color: white;
            padding: 30px;
            text-align: center;
        }

        header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        header p {
            opacity: 0.9;
            font-size: 1.1em;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            padding: 30px;
        }

        .section {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 0px;
            border: 2px solid #e9ecef;
        }

        .section.full-width {
            grid-column: 1 / -1;
        }

        h2 {
            color: #3498db;
            margin-bottom: 20px;
            font-size: 1.5em;
            border-bottom: 2px solid #3498db;
            padding-bottom: 10px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #495057;
        }

        select, input, textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #dee2e6;
            border-radius: 0px;
            font-size: 1em;
            transition: border-color 0.3s;
            background: white;
        }

        input[type="file"] {
            padding: 10px;
            cursor: pointer;
        }

        input[type="radio"] {
            width: auto;
            cursor: pointer;
        }

        select:focus, input:focus, textarea:focus {
            outline: none;
            border-color: #3498db;
        }

        textarea {
            resize: vertical;
            min-height: 150px;
            font-family: 'Courier New', monospace;
        }

        button {
            background: #3498db;
            color: white;
            border: none;
            padding: 14px 28px;
            border-radius: 0px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            margin-right: 10px;
            margin-bottom: 10px;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.4);
        }

        button:active {
            transform: translateY(0);
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-secondary {
            background: #6c757d;
        }

        .btn-success {
            background: #2980b9;
        }

        .info-box {
            background: white;
            padding: 15px;
            border-radius: 0px;
            margin-top: 15px;
            border-left: 4px solid #3498db;
        }

        .info-box h3 {
            color: #3498db;
            margin-bottom: 10px;
        }

        .info-box p {
            margin: 5px 0;
            color: #6c757d;
        }

        .status {
            padding: 12px;
            border-radius: 0px;
            margin-top: 15px;
            display: none;
        }

        .status.success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
            display: block;
        }

        .status.error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
            display: block;
        }

        .status.info {
            background: #d1ecf1;
            border: 1px solid #bee5eb;
            color: #0c5460;
            display: block;
        }

        .options-list {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
        }

        .option-badge {
            background: #3498db;
            color: white;
            padding: 8px 15px;
            border-radius: 0px;
            font-size: 0.9em;
        }

        .checkbox-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 10px;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px;
            background: #f8f9fa;
            border-radius: 0px;
        }

        .checkbox-item input[type="checkbox"] {
            width: auto;
            cursor: pointer;
        }

        .checkbox-item label {
            margin: 0;
            cursor: pointer;
            flex: 1;
        }

        .processors-order {
            margin-top: 15px;
            padding: 10px;
            background: #e8f4f8;
            border: 2px solid #3498db;
            border-radius: 0px;
            min-height: 50px;
        }

        .processors-order:empty::after {
            content: 'Vyberte procesory...';
            color: #666;
            font-style: italic;
        }

        .processor-chip {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: #3498db;
            color: white;
            padding: 8px 12px;
            border-radius: 0px;
            margin: 5px;
        }

        .processor-chip .move-btn {
            background: rgba(255,255,255,0.3);
            border: none;
            color: white;
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 0px;
            font-size: 12px;
        }

        .processor-chip .move-btn:hover {
            background: rgba(255,255,255,0.5);
        }

        .processor-chip .remove-btn {
            background: #e74c3c;
            border: none;
            color: white;
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 0px;
            font-weight: bold;
        }

        .processor-chip .remove-btn:hover {
            background: #c0392b;
        }

        #loadingOverlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        #loadingOverlay.show {
            display: flex;
        }

        .spinner {
            border: 5px solid #f3f3f3;
            border-top: 5px solid #3498db;
            border-radius: 0px;
            width: 60px;
            height: 60px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .metric-box {
            background: #3498db;
            padding: 20px;
            border-radius: 0px;
            text-align: center;
            color: white;
        }

        .metric-label {
            font-size: 0.9em;
            opacity: 0.9;
            margin-bottom: 8px;
        }

        .metric-value {
            font-size: 2em;
            font-weight: bold;
        }

        #metricsContainer h4 {
            color: #495057;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 2px solid #dee2e6;
        }

        /* Data Inspection Modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.7);
            animation: fadeIn 0.3s;
        }

        .modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background-color: white;
            padding: 30px;
            border-radius: 0px;
            max-width: 90%;
            max-height: 90%;
            overflow: auto;
            position: relative;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }

        .modal-close {
            position: absolute;
            top: 15px;
            right: 20px;
            font-size: 30px;
            font-weight: bold;
            color: #aaa;
            cursor: pointer;
            background: none;
            border: none;
            padding: 0;
            line-height: 1;
        }

        .modal-close:hover {
            color: #000;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            font-size: 0.9em;
        }

        .data-table th,
        .data-table td {
            border: 1px solid #dee2e6;
            padding: 10px;
            text-align: left;
        }

        .data-table th {
            background: #3498db;
            color: white;
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .data-table tbody tr:nth-child(even) {
            background: #f8f9fa;
        }

        .data-table tbody tr:hover {
            background: #e9ecef;
        }

        .feature-info {
            background: #ffffff;
            padding: 15px;
            border-radius: 0px;
            margin: 10px 0;
            border: 1px solid #dee2e6;
            border-left: 3px solid #495057;
        }

        .feature-info h4 {
            color: #495057;
            margin-bottom: 10px;
            font-weight: 600;
        }

        .feature-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 10px;
        }

        .feature-badge {
            background: #f8f9fa;
            color: #495057;
            padding: 6px 12px;
            border-radius: 0px;
            font-size: 0.85em;
            border: 1px solid #dee2e6;
        }

        .feature-badge.kept {
            border-left: 3px solid #495057;
        }

        .feature-badge.dropped {
            border-left: 3px solid #adb5bd;
            opacity: 0.7;
        }

        .feature-idx {
            font-size: 0.9em;
            color: #6c757d;
            font-family: 'Courier New', monospace;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        /* Target Recommendation Styles */
        .target-recommendation {
            margin-top: 15px;
            padding: 15px;
            background: white;
            border: 2px solid #3498db;
            border-radius: 0px;
            max-height: 600px;
            overflow-y: auto;
        }

        .target-recommendation h3 {
            color: #3498db;
            margin-bottom: 10px;
        }

        /* Selection Details Styles */
        .selection-details-container {
            margin-top: 20px;
            padding: 15px;
            background: white;
            border: 2px solid #3498db;
            border-radius: 0px;
            max-height: 600px;
            overflow: auto;
        }

        .selection-details-container h4 {
            color: #3498db;
            margin-bottom: 15px;
            border-bottom: 2px solid #3498db;
            padding-bottom: 8px;
        }

        .btn-analyze {
            background: #2980b9;
            width: 100%;
            margin-top: 10px;
            font-size: 1em;
        }

        .btn-analyze:hover {
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.4);
        }

        /* Column stats table */
        .column-stats {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85em;
            margin-bottom: 15px;
        }
        .column-stats th,
        .column-stats td {
            padding: 6px 10px;
            border: 1px solid #dee2e6;
            text-align: center;
        }
        .column-stats th {
            background: #3498db;
            color: white;
            font-size: 0.9em;
        }
        .column-stats tbody tr:nth-child(even) {
            background: #f8f9fa;
        }
        .column-stats tbody tr:hover {
            background: #e9ecef;
            cursor: pointer;
        }
        .column-stats tbody tr.selected-row {
            background: #d1ecf1;
            font-weight: bold;
        }

        /* Selector comparison grid */
        .selector-compare-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        .selector-compare-card {
            background: white;
            border: 2px solid #dee2e6;
            padding: 15px;
            transition: border-color 0.2s;
        }
        .selector-compare-card:hover {
            border-color: #3498db;
        }
        .selector-compare-card.active {
            border-color: #3498db;
            background: #f0f8ff;
        }
        .selector-compare-card .card-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }
        .selector-compare-card .card-header input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }
        .selector-compare-card .card-header label {
            margin: 0;
            font-weight: bold;
            color: #2c3e50;
            cursor: pointer;
            font-size: 1em;
        }
        .selector-compare-card .card-desc {
            font-size: 0.85em;
            color: #6c757d;
            margin-bottom: 10px;
        }
        .selector-compare-card .card-tags {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
        }
        .selector-compare-card .card-tag {
            font-size: 0.75em;
            padding: 2px 8px;
            background: #e9ecef;
            color: #495057;
        }
        .selector-compare-card .card-tag.warn {
            background: #fff3cd;
            color: #856404;
        }
        .selector-compare-card .card-params {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #dee2e6;
            display: none;
        }
        .selector-compare-card.active .card-params {
            display: block;
        }
        .selector-compare-card .card-params label {
            font-size: 0.85em;
            margin-bottom: 4px;
        }
        .selector-compare-card .card-params input {
            width: 100%;
            padding: 6px 10px;
            font-size: 0.9em;
        }

        /* Target method tabs */
        .target-method-tabs {
            display: flex;
            gap: 0;
            margin-bottom: 15px;
            border-bottom: 2px solid #dee2e6;
        }
        .target-method-tab {
            padding: 10px 20px;
            background: #f8f9fa;
            border: 2px solid #dee2e6;
            border-bottom: none;
            cursor: pointer;
            font-weight: 600;
            color: #6c757d;
            font-size: 0.9em;
            transition: all 0.2s;
            margin-bottom: -2px;
        }
        .target-method-tab:hover {
            color: #3498db;
        }
        .target-method-tab.active {
            background: white;
            color: #3498db;
            border-color: #3498db;
            border-bottom-color: white;
        }
        .target-method-content {
            display: none;
        }
        .target-method-content.active {
            display: block;
        }
    </style>
</head>
<body>
    <div id="loadingOverlay">
        <div class="spinner"></div>
    </div>

    <div class="container">
        <header>
            <h1>ML Pipeline Application</h1>
            <p>Kompletná Machine Learning Pipeline s podporou viacerých modelov a formátov</p>
        </header>

        <div class="main-content">
            <!-- Výber Komponenty -->
            <div class="section">
                <h2>1. Výber Pipeline</h2>
                
                <div class="form-group">
                    <label>Predpripravený Preset:</label>
                    <select id="presetSelect">
                        <option value="">-- Vlastná konfigurácia --</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Model:</label>
                    <select id="modelSelect">
                        <option value="">-- Vyberte model --</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Data Processors (voliteľné, v poradí):</label>
                    <div id="processorCheckboxes" class="checkbox-group"></div>
                    <div id="selectedProcessorsOrder" class="processors-order"></div>
                </div>

                <div class="form-group">
                    <label>Evaluation Mode:</label>
                    <select id="evalModeSelect">
                        <option value="">-- Auto --</option>
                        <option value="classification">Classification</option>
                        <option value="regression">Regression</option>
                    </select>
                </div>

                <div id="modelParamsContainer" style="display: none;">
                    <h3 style="margin-top: 20px; font-size: 1.1em;">Parametre modelu</h3>
                    <div class="form-group" id="knnKGroup" style="display: none;">
                        <label>K (počet susedov):</label>
                        <input type="number" id="knnK" placeholder="5" min="1" max="100" value="5">
                    </div>

                    <div class="form-group" id="treeMaxDepthGroup" style="display: none;">
                        <label>Max Depth (maximálna hĺbka stromu):</label>
                        <input type="number" id="treeMaxDepth" placeholder="10" min="1" max="50" value="10">
                    </div>
                </div>

                <button id="buildPipelineBtn">Vytvoriť Pipeline</button>
                
                <div id="pipelineStatus" class="status"></div>
            </div>

            <!-- Načítanie Dát -->
            <div class="section">
                <h2>2. Načítanie Dát</h2>
                
                <div class="form-group">
                    <label>Formát dát:</label>
                    <select id="dataFormatSelect">
                        <option value="csv">CSV</option>
                        <option value="json">JSON</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Spôsob zadania dát:</label>
                    <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                        <label style="cursor: pointer; display: flex; align-items: center; gap: 5px;">
                            <input type="radio" name="dataInputMethod" value="text" id="dataInputText" checked>
                            <span>Vložiť text</span>
                        </label>
                        <label style="cursor: pointer; display: flex; align-items: center; gap: 5px;">
                            <input type="radio" name="dataInputMethod" value="file" id="dataInputFile">
                            <span>Nahrať súbor</span>
                        </label>
                    </div>
                </div>

                <div class="form-group" id="textInputContainer">
                    <label>Vložte dáta:</label>
                    <textarea id="dataInput" placeholder="Vložte CSV alebo JSON dáta..."></textarea>
                </div>

                <div class="form-group" id="fileInputContainer" style="display: none;">
                    <label>Vyberte súbor:</label>
                    <input type="file" id="fileInput" accept=".csv,.json,.txt">
                    <div id="fileInfo" style="margin-top: 10px; font-size: 0.9em; color: #6c757d;"></div>
                    <button type="button" onclick="downloadSampleCSV()" style="margin-top: 10px; padding: 8px 16px; font-size: 0.9em; background: #3498db;">
                        Stiahnuť vzorový CSV súbor
                    </button>
                </div>

                <button id="parseDataBtn">Načítať dáta</button>
                <div id="parseStatus" class="status"></div>

                <div id="targetSelectionArea" style="display: none; margin-top: 20px; padding-top: 20px; border-top: 2px solid #dee2e6;">
                    <h3 style="color: #3498db; margin-bottom: 15px;">Výber cieľovej premennej</h3>

                    <!-- Target method tabs -->
                    <div class="target-method-tabs">
                        <div class="target-method-tab active" data-tab="manual" onclick="switchTargetTab('manual')">Manuálny výber</div>
                        <div class="target-method-tab" data-tab="stats" onclick="switchTargetTab('stats')">Štatistický prehľad</div>
                        <div class="target-method-tab" data-tab="analysis" onclick="switchTargetTab('analysis')">Analýza cieľovej premennej</div>
                    </div>

                    <!-- Tab: Manuálny výber -->
                    <div id="tabManual" class="target-method-content active">
                        <div class="form-group">
                            <label>Cieľový stĺpec:</label>
                            <select id="targetColumnSelect">
                                <option value="">-- Vyberte cieľový stĺpec --</option>
                            </select>
                        </div>
                    </div>

                    <!-- Tab: Štatistický prehľad -->
                    <div id="tabStats" class="target-method-content">
                        <p style="font-size: 0.9em; color: #6c757d; margin-bottom: 10px;">
                            Kliknite na riadok v tabuľke pre výber cieľovej premennej.
                        </p>
                        <div id="columnStatsContainer" style="overflow-x: auto;"></div>
                    </div>

                    <!-- Tab: Analýza cieľovej premennej -->
                    <div id="tabAnalysis" class="target-method-content">
                        <p style="font-size: 0.9em; color: #6c757d; margin-bottom: 10px;">
                            Vyberte metódu analýzy a spustite hodnotenie stĺpcov ako potenciálnych cieľových premenných.
                        </p>
                        <div style="display: flex; gap: 10px; align-items: flex-end; flex-wrap: wrap; margin-bottom: 10px;">
                            <div class="form-group" style="flex: 1; min-width: 200px; margin-bottom: 0;">
                                <label>Metóda analýzy:</label>
                                <select id="targetAnalysisMethod">
                                    <option value="correlation">Pearsonova korelácia (lineárne vzťahy)</option>
                                    <option value="mutual_information">Mutual Information (aj nelineárne vzťahy)</option>
                                    <option value="entropy">Entropia a Information Gain</option>
                                </select>
                            </div>
                            <button id="analyzeTargetBtn" class="btn-analyze" style="margin-bottom: 0; white-space: nowrap;">
                                Spustiť analýzu
                            </button>
                        </div>
                        <div id="targetMethodExplanation" style="font-size: 0.85em; color: #6c757d; padding: 8px; background: #f8f9fa; border-left: 3px solid #3498db; margin-bottom: 10px;"></div>
                        <div id="analyzeTargetStatus" class="status"></div>
                    </div>

                    <div class="form-group" style="margin-top: 15px;">
                        <label>Train/Test Split (% pre tréning):</label>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <input type="range" id="trainTestSplit" min="50" max="95" value="80" step="5" style="flex: 1;">
                            <span id="splitValue" style="min-width: 60px; font-weight: bold; color: #3498db;">80%</span>
                        </div>
                        <div style="font-size: 0.85em; color: #6c757d; margin-top: 5px;">
                            Train: <span id="trainPercent">80%</span> | Test: <span id="testPercent">20%</span>
                        </div>
                    </div>

                    <button id="confirmTargetBtn">Potvrdiť výber a načítať do pipeline</button>
                    <div id="dataStatus" class="status"></div>
                </div>

                <div style="margin-top: 15px; display: flex; gap: 10px; flex-wrap: wrap;">
                    <button id="inspectDataBtn" disabled style="flex: 1; min-width: 150px;">
                        Zobraziť dáta
                    </button>
                    <button id="inspectProcessedBtn" disabled style="flex: 1; min-width: 150px;">
                        Zobraziť spracované dáta
                    </button>
                </div>
            </div>

            <!-- Prieskum príznakov (Feature Exploration) -->
            <div class="section full-width" id="featureExplorationSection" style="display: none;">
                <h2>Prieskum a výber príznakov</h2>
                <p style="color: #6c757d; margin-bottom: 15px;">
                    Porovnajte rôzne metódy výberu príznakov na vašich dátach. 
                    Po porovnaní môžete natrénovať model s features vybranými jednotlivými selektormi a porovnať výsledky.
                </p>

                <div id="selectorCompareGrid" class="selector-compare-grid">
                    <!-- Dynamicky generované karty selektorov -->
                </div>

                <div style="margin-top: 20px; display: flex; gap: 10px; align-items: center;">
                    <button id="compareSelectorBtn" style="flex: 0 0 auto;">
                        Porovnať vybrané selektory
                    </button>
                    <button id="selectAllSelectorsBtn" class="btn-secondary" style="flex: 0 0 auto; padding: 10px 20px;">
                        Vybrať všetky
                    </button>
                    <span id="compareStatus" style="font-size: 0.9em; color: #6c757d;"></span>
                </div>
                <div id="compareSelectorStatus" class="status"></div>

                <!-- Výsledky porovnania a trénovania -->
                <div id="comparisonResultsArea" style="display: none; margin-top: 20px;">
                    <div style="display: flex; gap: 10px; align-items: center; margin-bottom: 15px; flex-wrap: wrap;">
                        <button id="trainAllSelectorsBtn" style="background: #27ae60; color: white; border: none; padding: 10px 20px; cursor: pointer; font-size: 14px;">
                            Natrénovať a porovnať všetky varianty
                        </button>
                        <span id="trainCompareStatus" style="font-size: 0.9em; color: #6c757d;"></span>
                    </div>
                    <div id="selectorTrainingResults"></div>
                </div>
            </div>

            <!-- Predikcia -->
            <div class="section full-width">
                <h2>Dostupné Možnosti</h2>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px;">
                    <div class="info-box">
                        <h3>Dostupné Modely</h3>
                        <div id="modelsInfo" class="options-list"></div>
                    </div>
                    
                    <div class="info-box">
                        <h3>Procesory</h3>
                        <div id="processorsInfo" class="options-list"></div>
                    </div>
                    
                    <div class="info-box">
                        <h3>Selektory</h3>
                        <div id="selectorsInfo" class="options-list"></div>
                    </div>
                </div>

                <div class="info-box" id="currentPipelineInfo" style="display: none; margin-top: 20px;">
                    <h3>Aktuálny Pipeline</h3>
                    <p><strong>Model:</strong> <span id="currentModel">-</span></p>
                    <p><strong>Processors:</strong> <span id="currentProcessor">-</span></p>
                    <p><strong>Eval Mode:</strong> <span id="currentEvalMode">-</span></p>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        let factory, pipeline, dataLoader;
        let availableOptions = null;
        let WasmDataLoaderClass = null;

        // Make functions globally available for inline handlers
        window.downloadSampleCSV = downloadSampleCSV;
        window.closeModal = closeModal;
        window.switchTargetTab = switchTargetTab;

        // Helper functions
        function calculateFeatureReduction(before, after) {
            return ((1 - after / before) * 100).toFixed(1);
        }

        function formatFeatureBadge(name, index, score, metricName, badgeClass) {
            const scoreText = score !== null && score !== undefined 
                ? ` = ${score.toFixed(4)} (${metricName})` 
                : '';
            return `<span class="feature-badge ${badgeClass}">${name} <span class="feature-idx">[${index}]${scoreText}</span></span>`;
        }

        function convertWasmResult(result) {
            if (result instanceof Map) {
                const obj = {};
                result.forEach((val, key) => {
                    obj[key] = convertWasmResult(val);
                });
                return obj;
            }
            if (Array.isArray(result)) {
                return result.map(item => convertWasmResult(item));
            }
            return result;
        }

        async function initApp() {
            try {
                showLoading(true);
                
                // Diagnostika pre GitHub Pages
                console.log('=== WASM INITIALIZATION DEBUG ===');
                console.log('Current URL:', window.location.href);
                console.log('Base URI:', document.baseURI);
                console.log('Origin:', window.location.origin);
                console.log('Pathname:', window.location.pathname);
                
                // Auto-detect base path for GitHub Pages
                const basePath = document.baseURI.endsWith('/') ? document.baseURI : document.baseURI + '/';
                const wasmPath = new URL('./pkg/wasm.js', basePath).href;
                console.log('Trying to load WASM from:', wasmPath);
                
                let wasmModule;
                try {
                    wasmModule = await import('./pkg/wasm.js');
                    console.log('✓ WASM module loaded successfully');
                } catch (importError) {
                    console.error('✗ Failed to import WASM module:', importError);
                    console.error('Import error details:', {
                        message: importError.message,
                        name: importError.name,
                        stack: importError.stack
                    });
                    throw new Error(`Nepodarilo sa načítať WASM modul z ./pkg/wasm.js\n\nChyba: ${importError.message}\n\nSkontrolujte:\n1. Či existuje súbor pkg/wasm.js\n2. Či je GitHub Pages správne nasadený\n3. Konzolu prehliadača pre ďalšie chyby`);
                }
                
                const init = wasmModule.default || wasmModule.init;
                const WasmFactory = wasmModule.WasmFactory;
                const WasmMLPipeline = wasmModule.WasmMLPipeline;
                WasmDataLoaderClass = wasmModule.WasmDataLoader; // Uložíme do globálnej premennej

                console.log('WASM exports:', {
                    init: typeof init,
                    WasmFactory: typeof WasmFactory,
                    WasmMLPipeline: typeof WasmMLPipeline,
                    WasmDataLoader: typeof WasmDataLoaderClass,
                    allExports: Object.keys(wasmModule)
                });

                if (!init || !WasmFactory) {
                    throw new Error('WASM module exports not found (wasm.js or pkg missing)');
                }

                console.log('Initializing WASM...');
                await init();
                console.log('✓ WASM initialized');

                factory = new WasmFactory();
                pipeline = new WasmMLPipeline();
                console.log('✓ Factory and Pipeline created');

                console.log('Fetching available options...');
                availableOptions = factory.getAvailableOptions();
                console.log('✓ Available options:', availableOptions);
                
                if (!availableOptions || !availableOptions.models || availableOptions.models.length === 0) {
                    throw new Error('Žiadne modely/selektory neboli načítané z WASM Factory. WASM modul môže byť nesprávne skompilovaný.');
                }

                console.log('Populating UI options...');
                populateOptions();
                console.log('✓ UI populated');
                
                console.log('Setting up event listeners...');
                setupEventListeners();
                console.log('✓ Event listeners ready');

                console.log('=== INITIALIZATION COMPLETE ===');
                showStatus('info', 'Aplikácia pripravená!', 'parseStatus');
            } catch (error) {
                console.error('=== INIT ERROR ===');
                console.error('Init error:', error);
                console.error('Error stack:', error.stack);
                const message = (error && error.message) ? error.message : String(error);
                showStatus('error', `Chyba pri načítaní WASM: ${message}\n\nOtvorte Developer Console (F12) pre viac detailov.`, 'parseStatus');
                
                // Zobrazenie viditeľného erroru na stránke
                document.body.innerHTML += `
                    <div style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); 
                                background: #f8d7da; border: 3px solid #f5c6cb; padding: 30px; 
                                border-radius: 10px; max-width: 600px; z-index: 9999; box-shadow: 0 10px 40px rgba(0,0,0,0.3);">
                        <h2 style="color: #721c24; margin-bottom: 15px;">Chyba inicializácie WASM</h2>
                        <p style="color: #721c24; margin-bottom: 10px;"><strong>Chyba:</strong> ${message}</p>
                        <p style="color: #721c24; font-size: 0.9em;">Otvorte Developer Console (F12) pre viac informácií.</p>
                        <hr style="margin: 15px 0; border-color: #f5c6cb;">
                        <p style="color: #721c24; font-size: 0.85em;">
                            <strong>Možné príčiny:</strong><br>
                            • WASM súbory neboli správne nasadené na GitHub Pages<br>
                            • Nesprávne MIME typy pre .wasm súbory<br>
                            • CORS problémy pri načítaní modulov<br>
                            • Cesta k pkg/wasm.js je nesprávna
                        </p>
                    </div>
                `;
            } finally {
                showLoading(false);
            }
        }

        function populateOptions() {
            if (!availableOptions) return;

            const modelSelect = document.getElementById('modelSelect');
            availableOptions.models.forEach(m => {
                const opt = document.createElement('option');
                opt.value = m.name;
                opt.textContent = `${m.name} - ${m.description}`;
                modelSelect.appendChild(opt);
            });

            // Vytvoríme checkboxy pre procesory
            const processorCheckboxes = document.getElementById('processorCheckboxes');
            availableOptions.processors.forEach(p => {
                const item = document.createElement('div');
                item.className = 'checkbox-item';
                
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.id = `proc_${p.name}`;
                checkbox.value = p.name;
                checkbox.addEventListener('change', updateProcessorOrder);
                
                const label = document.createElement('label');
                label.htmlFor = `proc_${p.name}`;
                label.textContent = `${p.name} - ${p.description}`;
                
                item.appendChild(checkbox);
                item.appendChild(label);
                processorCheckboxes.appendChild(item);
            });

            const presetSelect = document.getElementById('presetSelect');
            availableOptions.presets.forEach(p => {
                const opt = document.createElement('option');
                opt.value = p.name;
                opt.textContent = `${p.name} - ${p.description}`;
                presetSelect.appendChild(opt);
            });

            displayInfo();
        }

        function displayInfo() {
            const modelsDiv = document.getElementById('modelsInfo');
            availableOptions.models.forEach(m => {
                const badge = document.createElement('span');
                badge.className = 'option-badge';
                badge.textContent = m.name;
                badge.title = m.description;
                modelsDiv.appendChild(badge);
            });

            const processorsDiv = document.getElementById('processorsInfo');
            availableOptions.processors.forEach(p => {
                const badge = document.createElement('span');
                badge.className = 'option-badge';
                badge.textContent = p.name;
                processorsDiv.appendChild(badge);
            });

            const selectorsDiv = document.getElementById('selectorsInfo');
            availableOptions.selectors.forEach(s => {
                const badge = document.createElement('span');
                badge.className = 'option-badge';
                badge.textContent = s.name;
                selectorsDiv.appendChild(badge);
            });
        }

        // Zoznam vybraných procesorov v poradí
        let selectedProcessors = [];

        function updateProcessorOrder() {
            const checkboxes = document.querySelectorAll('#processorCheckboxes input[type="checkbox"]');
            const orderDiv = document.getElementById('selectedProcessorsOrder');
            
            // Aktualizuj selectedProcessors podľa checkboxov
            const currentChecked = Array.from(checkboxes)
                .filter(cb => cb.checked)
                .map(cb => cb.value);
            
            // Pridaj nové procesory na koniec
            currentChecked.forEach(proc => {
                if (!selectedProcessors.includes(proc)) {
                    selectedProcessors.push(proc);
                }
            });
            
            // Odstráň odškrtnuté procesory
            selectedProcessors = selectedProcessors.filter(proc => currentChecked.includes(proc));
            
            // Vyrenderuj chips
            orderDiv.innerHTML = '';
            selectedProcessors.forEach((proc, idx) => {
                const chipContainer = document.createElement('div');
                chipContainer.style.marginBottom = '10px';
                
                const chip = document.createElement('div');
                chip.className = 'processor-chip';
                
                if (idx > 0) {
                    const moveUpBtn = document.createElement('button');
                    moveUpBtn.className = 'move-btn';
                    moveUpBtn.textContent = '↑';
                    moveUpBtn.onclick = () => moveProcessor(idx, idx - 1);
                    chip.appendChild(moveUpBtn);
                }
                
                if (idx < selectedProcessors.length - 1) {
                    const moveDownBtn = document.createElement('button');
                    moveDownBtn.className = 'move-btn';
                    moveDownBtn.textContent = '↓';
                    moveDownBtn.onclick = () => moveProcessor(idx, idx + 1);
                    chip.appendChild(moveDownBtn);
                }
                
                const label = document.createElement('span');
                label.textContent = proc;
                chip.appendChild(label);
                
                const removeBtn = document.createElement('button');
                removeBtn.className = 'remove-btn';
                removeBtn.textContent = '×';
                removeBtn.onclick = () => {
                    document.getElementById(`proc_${proc}`).checked = false;
                    updateProcessorOrder();
                };
                chip.appendChild(removeBtn);
                
                chipContainer.appendChild(chip);
                
                // Načítaj a zobraz parametre procesora
                const paramDefs = factory.getProcessorParamDefinitions(proc);
                if (paramDefs && paramDefs.length > 0) {
                    const paramsDiv = document.createElement('div');
                    paramsDiv.style.marginLeft = '20px';
                    paramsDiv.style.marginTop = '5px';
                    
                    paramDefs.forEach(param => {
                        const paramDiv = document.createElement('div');
                        paramDiv.style.marginBottom = '5px';
                        
                        const paramLabel = document.createElement('label');
                        paramLabel.textContent = `${param.description}: `;
                        paramLabel.style.fontSize = '0.9em';
                        
                        const paramInput = document.createElement('input');
                        paramInput.type = param.param_type === 'number' ? 'number' : 'text';
                        paramInput.value = param.default_value;
                        paramInput.id = `param_${proc}_${param.name}`;
                        paramInput.style.width = '80px';
                        paramInput.style.marginLeft = '5px';
                        
                        if (param.min !== null && param.min !== undefined) {
                            paramInput.min = param.min;
                        }
                        if (param.max !== null && param.max !== undefined) {
                            paramInput.max = param.max;
                        }
                        
                        paramDiv.appendChild(paramLabel);
                        paramDiv.appendChild(paramInput);
                        paramsDiv.appendChild(paramDiv);
                    });
                    
                    chipContainer.appendChild(paramsDiv);
                }
                
                orderDiv.appendChild(chipContainer);
            });
        }

        function moveProcessor(fromIdx, toIdx) {
            const temp = selectedProcessors[fromIdx];
            selectedProcessors[fromIdx] = selectedProcessors[toIdx];
            selectedProcessors[toIdx] = temp;
            updateProcessorOrder();
        }

        function setupEventListeners() {
            document.getElementById('buildPipelineBtn').onclick = buildPipeline;
            document.getElementById('parseDataBtn').onclick = parseData;
            document.getElementById('confirmTargetBtn').onclick = confirmTarget;
            document.getElementById('inspectDataBtn').onclick = inspectData;
            document.getElementById('inspectProcessedBtn').onclick = inspectProcessedData;
            document.getElementById('analyzeTargetBtn').onclick = analyzeTargets;
            document.getElementById('compareSelectorBtn').onclick = compareSelectors;
            document.getElementById('selectAllSelectorsBtn').onclick = toggleAllSelectors;
            document.getElementById('trainAllSelectorsBtn').onclick = trainAllSelectors;
            
            // Data input method radio buttons
            document.getElementById('dataInputText').onchange = toggleDataInputMethod;
            document.getElementById('dataInputFile').onchange = toggleDataInputMethod;
            
            // Train/Test split slider
            document.getElementById('trainTestSplit').oninput = function(e) {
                const trainPercent = parseInt(e.target.value);
                const testPercent = 100 - trainPercent;
                document.getElementById('splitValue').textContent = `${trainPercent}%`;
                document.getElementById('trainPercent').textContent = `${trainPercent}%`;
                document.getElementById('testPercent').textContent = `${testPercent}%`;
            };
            
            // File input change listener
            document.getElementById('fileInput').onchange = function(e) {
                const file = e.target.files[0];
                if (file) {
                    const fileInfo = document.getElementById('fileInfo');
                    fileInfo.textContent = `Vybraný súbor: ${file.name} (${(file.size / 1024).toFixed(2)} KB)`;
                    
                    // Auto-detect format from file extension
                    const ext = file.name.split('.').pop().toLowerCase();
                    if (ext === 'csv') {
                        document.getElementById('dataFormatSelect').value = 'csv';
                    } else if (ext === 'json') {
                        document.getElementById('dataFormatSelect').value = 'json';
                    }
                }
            };
            
            document.getElementById('presetSelect').onchange = function() {
                const preset = this.value;
                const isCustom = !preset;
                
                document.getElementById('modelSelect').disabled = !isCustom;
                // Processor checkboxy ostanú vždy enabled
                document.getElementById('evalModeSelect').disabled = !isCustom;
                
                if (preset) {
                    // Získaj detaily presetu a zobraz relevantné parametre
                    const presetDetails = factory.getPresetDetails(preset);
                    if (presetDetails) {
                        // Zobraz polia pre model ak je definovaný
                        if (presetDetails.model) {
                            updateModelParams(presetDetails.model);
                        } else {
                            hideAllParamFields();
                        }
                    }
                } else {
                    hideAllParamFields();
                }
            };

            document.getElementById('modelSelect').onchange = function() {
                updateModelParams(this.value);
            };
        }
        
        function checkBinningRequirement(selectorName) {
            if (!selectorName || !availableOptions) return;
            
            const selectorInfo = availableOptions.selectors.find(s => s.name === selectorName);
            if (selectorInfo && selectorInfo.requires_binning) {
                // Skontroluj či je binner v selectedProcessors
                if (!selectedProcessors.includes('binner')) {
                    const binnerCheckbox = document.getElementById('proc_binner');
                    if (binnerCheckbox && !binnerCheckbox.checked) {
                        binnerCheckbox.checked = true;
                        updateProcessorOrder();
                        
                        alert('Information Gain vyžaduje diskrétne dáta.\n\nAutomaticky bol pridaný Binner processor do pipeline.\n\nAk chcete použiť vlastné binning nastavenie, upravte poradie procesorov.');
                    }
                }
            }
        }

        function hideAllParamFields() {
            document.getElementById('modelParamsContainer').style.display = 'none';
            document.getElementById('knnKGroup').style.display = 'none';
            document.getElementById('treeMaxDepthGroup').style.display = 'none';
        }

        function updateModelParams(modelName) {
            hideAllParamFields();
            
            if (!modelName) return;

            const params = factory.getModelParams(modelName);
            
            if (params.length > 0) {
                document.getElementById('modelParamsContainer').style.display = 'block';
                
                params.forEach(param => {
                    if (param === 'k') {
                        document.getElementById('knnKGroup').style.display = 'block';
                    } else if (param === 'max_depth') {
                        document.getElementById('treeMaxDepthGroup').style.display = 'block';
                    }
                });
            }
        }

        async function buildPipeline() {
            try {
                showLoading(true);
                
                const preset = document.getElementById('presetSelect').value;
                const model = document.getElementById('modelSelect').value;
                const processors = selectedProcessors;
                const evalMode = document.getElementById('evalModeSelect').value;

                console.log('=== BUILD PIPELINE START ===');
                console.log('Preset:', preset);
                console.log('Model:', model);
                console.log('Processors:', processors);
                console.log('EvalMode:', evalMode);

                let result;

                if (preset) {
                    // Použiť preset - zozbierať parametre
                    const presetDetails = factory.getPresetDetails(preset);
                    console.log('Preset Details:', presetDetails);
                    
                    const modelParams = [];

                    // Zozbierať model parametre ak sú viditeľné
                    const knnK = document.getElementById('knnK').value;
                    if (knnK && presetDetails.model === 'knn') {
                        modelParams.push(['k', knnK]);
                    }

                    const treeMaxDepth = document.getElementById('treeMaxDepth').value;
                    if (treeMaxDepth && presetDetails.model === 'tree') {
                        modelParams.push(['max_depth', treeMaxDepth]);
                    }

                    const presetModel = presetDetails.model || model || 'knn';
                    
                    result = await pipeline.buildFromPreset(
                        preset, 
                        presetModel,
                        modelParams.length > 0 ? modelParams : null,
                        null
                    );
                } else {
                    // Vlastná konfigurácia
                    if (!model) throw new Error('Vyberte model');

                    // Validácia evaluation_mode vs model
                    if (evalMode) {
                        if (model === 'linreg' && evalMode === 'classification') {
                            showStatus('error', 'Upozornenie: Lineárna regresia (linreg) vyžaduje evaluation_mode = "regression", nie "classification".', 'pipelineStatus');
                            if (!confirm('Vybrali ste nekompatibilný evaluation_mode.\n\nModel: Lineárna Regresia (linreg)\nEvaluation Mode: classification\n\nMal by byť: regression\n\nChcete pokračovať?')) {
                                return;
                            }
                        }
                        if (model === 'logreg' && evalMode === 'regression') {
                            showStatus('error', 'Upozornenie: Logistická regresia (logreg) vyžaduje evaluation_mode = "classification", nie "regression".', 'pipelineStatus');
                            if (!confirm('Vybrali ste nekompatibilný evaluation_mode.\n\nModel: Logistická Regresia (logreg)\nEvaluation Mode: regression\n\nMal by byť: classification\n\nChcete pokračovať?')) {
                                return;
                            }
                        }
                    }

                    // Zozbierať parametre
                    const modelParams = [];

                    const knnK = document.getElementById('knnK').value;
                    if (knnK && model === 'knn') {
                        modelParams.push(['k', knnK]);
                    }

                    const treeMaxDepth = document.getElementById('treeMaxDepth').value;
                    if (treeMaxDepth && model === 'tree') {
                        modelParams.push(['max_depth', treeMaxDepth]);
                    }

                    // Zozbierať parametre procesorov z dynamických inputov
                    const processorParams = [];
                    processors.forEach(proc => {
                        const paramDefs = factory.getProcessorParamDefinitions(proc);
                        if (paramDefs && paramDefs.length > 0) {
                            paramDefs.forEach(paramDef => {
                                const inputId = `param_${proc}_${paramDef.name}`;
                                const input = document.getElementById(inputId);
                                if (input && input.value) {
                                    processorParams.push([proc, paramDef.name, input.value]);
                                }
                            });
                        }
                    });

                    const config = {
                        model: model,
                        processors: processors.length > 0 ? processors : [],
                        processor: null,
                        selector: null,
                        evaluation_mode: evalMode || null,
                        model_params: modelParams.length > 0 ? modelParams : null,
                        selector_params: null,
                        processor_params: processorParams.length > 0 ? processorParams : null
                    };

                    result = await pipeline.buildFromConfig(config);
                }
                
                document.getElementById('currentPipelineInfo').style.display = 'block';
                document.getElementById('currentModel').textContent = result.model_name;
                
                const processorText = result.processors && result.processors.length > 0 
                    ? result.processors.join(' → ') 
                    : 'Žiadny';
                document.getElementById('currentProcessor').textContent = processorText;
                document.getElementById('currentEvalMode').textContent = result.evaluation_mode;
                
                window.pipelineBuilt = true;
                showStatus('success', 'Pipeline vytvorený!', 'pipelineStatus');
            } catch (error) {
                console.error('Build pipeline error:', error);
                showStatus('error', `Chyba: ${error}`, 'pipelineStatus');
            } finally {
                showLoading(false);
            }
        }

        function toggleDataInputMethod() {
            const method = document.querySelector('input[name="dataInputMethod"]:checked').value;
            const textContainer = document.getElementById('textInputContainer');
            const fileContainer = document.getElementById('fileInputContainer');
            
            if (method === 'text') {
                textContainer.style.display = 'block';
                fileContainer.style.display = 'none';
            } else {
                textContainer.style.display = 'none';
                fileContainer.style.display = 'block';
            }
        }

        function downloadSampleCSV() {
            const csvContent = `age,income,credit_score,debt_ratio,employment_years,education_level,num_accounts,account_balance,loan_amount,monthly_payment,savings,investment_score,property_value,approved
25,50000,700,0.35,3,2,4,12500,15000,450,8000,65,0,1
35,75000,750,0.28,8,3,6,28000,22000,680,25000,78,180000,1
45,60000,650,0.42,15,2,3,8500,28000,820,15000,58,150000,0
22,30000,600,0.48,1,1,2,3500,12000,380,2500,42,0,0
50,90000,800,0.22,20,4,8,45000,35000,920,55000,88,320000,1
30,55000,680,0.38,5,3,5,15000,18000,520,12000,68,0,1
40,80000,720,0.30,12,3,7,32000,25000,750,30000,75,220000,1
28,45000,640,0.44,4,2,3,7500,20000,610,6000,55,0,0
55,95000,790,0.20,25,4,9,58000,40000,980,68000,92,450000,1
32,62000,710,0.33,7,3,6,18500,21000,640,16000,72,125000,1
38,72000,730,0.29,10,3,7,26000,24000,710,28000,76,195000,1
27,48000,660,0.40,3,2,4,9500,17000,550,9500,60,0,0
52,88000,780,0.24,22,4,8,42000,32000,890,52000,86,380000,1
29,51000,670,0.37,4,2,5,11500,19000,570,11000,63,0,1
43,68000,700,0.32,13,3,6,21000,23000,690,22000,74,175000,1
24,42000,630,0.45,2,2,3,6000,14000,480,5000,50,0,0
48,82000,760,0.26,18,3,7,35000,28000,820,38000,82,280000,1
31,58000,690,0.36,6,3,5,14000,20000,600,13500,66,110000,1
36,70000,725,0.31,9,3,6,24000,26000,730,26000,77,200000,1
26,46000,655,0.41,3,2,4,8000,16000,520,7500,58,0,0
53,92000,795,0.21,24,4,9,50000,38000,950,62000,90,410000,1
33,64000,705,0.34,8,3,6,19500,22000,660,18000,70,140000,1
41,76000,740,0.27,14,3,7,30000,27000,780,32000,80,240000,1
23,38000,620,0.47,1,1,2,4500,13000,420,3500,45,0,0
49,85000,770,0.25,19,4,8,40000,33000,870,48000,84,350000,1
34,66000,715,0.30,9,3,6,22000,24000,700,24000,73,160000,1
39,74000,735,0.28,11,3,7,28000,26000,760,29000,78,210000,1
28,49000,665,0.39,4,2,4,10000,18000,560,10500,62,0,0
54,94000,785,0.23,23,4,9,55000,36000,930,65000,89,430000,1
30,56000,685,0.35,5,3,5,13500,19000,590,14500,67,95000,1`;
            
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            
            link.setAttribute('href', url);
            link.setAttribute('download', 'sample_data.csv');
            link.style.visibility = 'hidden';
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        async function getDataString() {
            const method = document.querySelector('input[name="dataInputMethod"]:checked').value;
            if (method === 'text') {
                const data = document.getElementById('dataInput').value;
                if (!data) throw new Error('Vložte dáta');
                return data;
            } else {
                const fileInput = document.getElementById('fileInput');
                const file = fileInput.files[0];
                if (!file) throw new Error('Vyberte súbor');
                return await new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = (e) => resolve(e.target.result);
                    reader.onerror = () => reject(new Error('Chyba pri čítaní súboru'));
                    reader.readAsText(file);
                });
            }
        }

        async function parseData() {
            try {
                showLoading(true);
                const format = document.getElementById('dataFormatSelect').value;
                const data = await getDataString();

                window.rawDataString = data;
                window.dataFormat = format;

                dataLoader = new WasmDataLoaderClass(format);
                const columns = await dataLoader.getAvailableColumns(data);
                window.parsedColumns = columns;

                const targetSelect = document.getElementById('targetColumnSelect');
                targetSelect.innerHTML = '';
                columns.forEach(col => {
                    const opt = document.createElement('option');
                    opt.value = col;
                    opt.textContent = col;
                    targetSelect.appendChild(opt);
                });

                // Build column stats table
                buildColumnStatsTable(data, columns, format);

                document.getElementById('targetSelectionArea').style.display = 'block';
                document.getElementById('inspectDataBtn').disabled = true;
                document.getElementById('inspectProcessedBtn').disabled = true;

                // Show feature exploration section and populate selector cards
                document.getElementById('featureExplorationSection').style.display = 'block';
                populateComparisonSelectors();
                populateTargetAnalyzerMethods();

                showStatus('success', `Dáta načítané: ${columns.length} stĺpcov nájdených. Vyberte cieľovú premennú.`, 'parseStatus');
            } catch (error) {
                showStatus('error', `Chyba: ${error}`, 'parseStatus');
            } finally {
                showLoading(false);
            }
        }

        async function confirmTarget() {
            try {
                showLoading(true);
                const targetColumn = document.getElementById('targetColumnSelect').value;
                if (!targetColumn) {
                    showStatus('error', 'Vyberte cieľový stĺpec', 'dataStatus');
                    return;
                }

                const data = window.rawDataString;
                const format = window.dataFormat;
                if (!data) {
                    showStatus('error', 'Najprv načítajte dáta', 'dataStatus');
                    return;
                }

                const result = await pipeline.loadData(data, targetColumn, format);

                const trainPercent = parseInt(document.getElementById('trainTestSplit').value) / 100;
                window.trainTestRatio = trainPercent;

                document.getElementById('inspectDataBtn').disabled = false;

                showStatus('success', `${result.message} (Train: ${Math.round(trainPercent * 100)}%, Test: ${Math.round((1 - trainPercent) * 100)}%)`, 'dataStatus');
            } catch (error) {
                showStatus('error', `Chyba: ${error}`, 'dataStatus');
            } finally {
                showLoading(false);
            }
        }

        async function analyzeTargets() {
            try {
                showLoading(true);
                const data = window.rawDataString;
                const format = window.dataFormat;
                if (!data) {
                    showStatus('error', 'Najprv načítajte dáta', 'analyzeTargetStatus');
                    return;
                }

                const method = document.getElementById('targetAnalysisMethod').value;
                const rawResult = await pipeline.analyzeTargetWith(data, format, method);
                const result = convertWasmResult(rawResult);

                // Open results in modal
                const modal = document.getElementById('dataModal');
                document.getElementById('modalTitle').textContent = `Analýza cieľovej premennej - ${result.method_description || method}`;
                document.getElementById('modalBody').innerHTML = result.html;
                modal.classList.add('show');

                if (result.recommended_target) {
                    const targetSelect = document.getElementById('targetColumnSelect');
                    for (const opt of targetSelect.options) {
                        if (opt.value === result.recommended_target) {
                            targetSelect.value = result.recommended_target;
                            break;
                        }
                    }
                    // Also highlight in stats table
                    highlightStatsRow(result.recommended_target);
                }

                if (result.recommended_type) {
                    document.getElementById('evalModeSelect').value = result.recommended_type;
                }

                showStatus('success', `Odporúčaná: ${result.recommended_target} (${result.recommended_type})`, 'analyzeTargetStatus');
            } catch (error) {
                showStatus('error', `Chyba analýzy: ${error}`, 'analyzeTargetStatus');
            } finally {
                showLoading(false);
            }
        }

        // Select target from analysis table rows (called from WASM-generated HTML)
        function selectTargetFromAnalysis(colName, suggestedType) {
            const targetSelect = document.getElementById('targetColumnSelect');
            targetSelect.value = colName;
            highlightStatsRow(colName);
            if (suggestedType) {
                document.getElementById('evalModeSelect').value = suggestedType;
            }
            // Close modal
            document.getElementById('dataModal').classList.remove('show');
            switchTargetTab('manual');
        }
        window.selectTargetFromAnalysis = selectTargetFromAnalysis;

        // ===== Target selection helpers =====

        function switchTargetTab(tabName) {
            document.querySelectorAll('.target-method-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.target-method-content').forEach(c => c.classList.remove('active'));
            document.querySelector(`.target-method-tab[data-tab="${tabName}"]`).classList.add('active');
            const tabMap = { manual: 'tabManual', stats: 'tabStats', analysis: 'tabAnalysis' };
            document.getElementById(tabMap[tabName]).classList.add('active');
        }

        function populateTargetAnalyzerMethods() {
            try {
                const rawAnalyzers = pipeline.getAvailableTargetAnalyzers();
                const analyzers = convertWasmResult(rawAnalyzers);
                if (!analyzers || !analyzers.length) return;

                const select = document.getElementById('targetAnalysisMethod');
                select.innerHTML = '';
                analyzers.forEach(a => {
                    const opt = document.createElement('option');
                    opt.value = a.name;
                    opt.textContent = `${a.metric_name} - ${a.description}`;
                    select.appendChild(opt);
                });

                // Show explanation for the initially selected method
                updateTargetMethodExplanation(analyzers, select.value);

                // Update explanation on change
                select.onchange = () => updateTargetMethodExplanation(analyzers, select.value);

                window._targetAnalyzers = analyzers;
            } catch (e) {
                console.warn('Could not load target analyzers:', e);
            }
        }

        function updateTargetMethodExplanation(analyzers, selectedMethod) {
            const explanationDiv = document.getElementById('targetMethodExplanation');
            const found = analyzers.find(a => a.name === selectedMethod);
            if (found && explanationDiv) {
                explanationDiv.innerHTML = `<strong>${found.metric_name}:</strong> ${found.metric_explanation}`;
            }
        }

        function buildColumnStatsTable(data, columns, format) {
            if (format !== 'csv') {
                document.getElementById('columnStatsContainer').innerHTML = '<p style="color:#6c757d;">Štatistický prehľad je dostupný len pre CSV formát.</p>';
                return;
            }
            const lines = data.split('\n').filter(l => l.trim());
            if (lines.length < 2) return;

            const headers = lines[0].split(',').map(h => h.trim());
            const rows = lines.slice(1).map(l => l.split(',').map(v => v.trim()));

            let html = '<table class="column-stats"><thead><tr>';
            html += '<th>Stĺpec</th><th>Typ</th><th>Unikátnych</th><th>Min</th><th>Max</th><th>Priemer</th><th>Odporúčanie</th>';
            html += '</tr></thead><tbody>';

            columns.forEach((col, colIdx) => {
                // Find column index in headers (might not match columns if target excluded)
                const hIdx = headers.indexOf(col);
                if (hIdx === -1) return;

                const values = rows.map(r => r[hIdx]).filter(v => v !== undefined && v !== '');
                const numValues = values.map(Number).filter(v => !isNaN(v));
                const isNumeric = numValues.length > values.length * 0.8;
                const uniqueCount = new Set(values).size;

                let min = '-', max = '-', mean = '-';
                if (isNumeric && numValues.length > 0) {
                    min = Math.min(...numValues).toFixed(2);
                    max = Math.max(...numValues).toFixed(2);
                    mean = (numValues.reduce((a,b) => a+b, 0) / numValues.length).toFixed(2);
                }

                const ratio = uniqueCount / values.length;
                let typeLabel, suggestion;
                if (!isNumeric) {
                    typeLabel = 'Kategorický';
                    suggestion = uniqueCount <= 10 ? 'Klasifikácia' : 'Kategorický';
                } else if (uniqueCount <= 10 || ratio < 0.05) {
                    typeLabel = 'Diskrétny';
                    suggestion = 'Klasifikácia';
                } else {
                    typeLabel = 'Spojitý';
                    suggestion = 'Regresia';
                }

                html += `<tr data-column="${col}" onclick="selectTargetFromStats('${col}')">`;
                html += `<td style="text-align:left;font-weight:bold;">${col}</td>`;
                html += `<td>${typeLabel}</td>`;
                html += `<td>${uniqueCount}</td>`;
                html += `<td>${min}</td>`;
                html += `<td>${max}</td>`;
                html += `<td>${mean}</td>`;
                html += `<td><span style="font-size:0.85em;padding:2px 8px;background:${suggestion === 'Klasifikácia' ? '#d1ecf1' : suggestion === 'Regresia' ? '#e8f4f8' : '#f8f9fa'};">${suggestion}</span></td>`;
                html += '</tr>';
            });
            html += '</tbody></table>';
            document.getElementById('columnStatsContainer').innerHTML = html;
        }

        function selectTargetFromStats(colName) {
            const targetSelect = document.getElementById('targetColumnSelect');
            targetSelect.value = colName;
            highlightStatsRow(colName);
            // Switch to manual tab to show the dropdown
            switchTargetTab('manual');
        }
        window.selectTargetFromStats = selectTargetFromStats;

        function highlightStatsRow(colName) {
            document.querySelectorAll('.column-stats tbody tr').forEach(tr => {
                tr.classList.toggle('selected-row', tr.dataset.column === colName);
            });
        }

        // ===== Feature exploration / selector comparison =====

        function populateComparisonSelectors() {
            if (!availableOptions || !availableOptions.selectors) return;
            const grid = document.getElementById('selectorCompareGrid');
            grid.innerHTML = '';

            availableOptions.selectors.forEach(sel => {
                const card = document.createElement('div');
                card.className = 'selector-compare-card';
                card.id = `compare_card_${sel.name}`;

                const tags = sel.supported_types.map(t =>
                    `<span class="card-tag">${t}</span>`
                ).join('');
                const warnTag = sel.requires_binning
                    ? '<span class="card-tag warn">Vyžaduje Binner</span>'
                    : '';

                // Build param inputs based on selector type
                let paramsHtml = '';
                const params = factory.getSelectorParams(sel.name);
                if (params && params.length > 0) {
                    params.forEach(p => {
                        let defaultVal = '';
                        let label = p;
                        if (p === 'num_features') {
                            defaultVal = '5';
                            label = 'Počet features';
                        } else if (p === 'threshold') {
                            defaultVal = sel.name === 'correlation' ? '0.95' : '0.01';
                            label = 'Prahová hodnota';
                        }
                        paramsHtml += `<div class="form-group" style="margin-bottom:8px;">
                            <label>${label} (${p}):</label>
                            <input type="number" step="any" value="${defaultVal}" id="compare_param_${sel.name}_${p}">
                        </div>`;
                    });
                }

                card.innerHTML = `
                    <div class="card-header">
                        <input type="checkbox" id="compare_sel_${sel.name}" onchange="toggleCompareCard('${sel.name}')">
                        <label for="compare_sel_${sel.name}">${sel.name}</label>
                    </div>
                    <div class="card-desc">${sel.description}</div>
                    <div class="card-tags">${tags}${warnTag}</div>
                    <div class="card-params">${paramsHtml}</div>
                `;
                grid.appendChild(card);
            });
        }

        function toggleCompareCard(name) {
            const cb = document.getElementById(`compare_sel_${name}`);
            const card = document.getElementById(`compare_card_${name}`);
            card.classList.toggle('active', cb.checked);
        }
        window.toggleCompareCard = toggleCompareCard;

        function toggleAllSelectors() {
            const cards = document.querySelectorAll('.selector-compare-card');
            const allChecked = Array.from(cards).every(c => c.classList.contains('active'));
            cards.forEach(card => {
                const cb = card.querySelector('input[type="checkbox"]');
                cb.checked = !allChecked;
                card.classList.toggle('active', !allChecked);
            });
        }

        async function compareSelectors() {
            try {
                const targetColumn = document.getElementById('targetColumnSelect').value;
                if (!targetColumn) {
                    showStatus('error', 'Najprv vyberte cieľovú premennú', 'compareSelectorStatus');
                    return;
                }
                if (!pipeline) {
                    showStatus('error', 'Pipeline nie je inicializovaný', 'compareSelectorStatus');
                    return;
                }
                const data = window.rawDataString;
                const format = window.dataFormat;
                if (!data) {
                    showStatus('error', 'Najprv načítajte dáta', 'compareSelectorStatus');
                    return;
                }

                // Collect selected selectors and their params
                const selectorConfigs = [];
                document.querySelectorAll('.selector-compare-card.active').forEach(card => {
                    const name = card.id.replace('compare_card_', '');
                    const params = [];
                    card.querySelectorAll('.card-params input').forEach(input => {
                        const paramName = input.id.replace(`compare_param_${name}_`, '');
                        if (input.value) {
                            params.push([paramName, input.value]);
                        }
                    });
                    selectorConfigs.push({ name, params });
                });

                if (selectorConfigs.length === 0) {
                    showStatus('error', 'Vyberte aspoň jeden selektor na porovnanie', 'compareSelectorStatus');
                    return;
                }

                showLoading(true);
                showStatus('info', `Porovnávam ${selectorConfigs.length} selektorov...`, 'compareSelectorStatus');

                const rawResult = await pipeline.compareSelectors(data, targetColumn, format, selectorConfigs);
                const result = convertWasmResult(rawResult);

                // Store results for training
                window._lastComparisonResult = result;

                // Open comparison in modal
                const modal = document.getElementById('dataModal');
                document.getElementById('modalTitle').textContent = `Porovnanie selektorov (cieľ: ${targetColumn})`;
                document.getElementById('modalBody').innerHTML = result.comparison_html;
                modal.classList.add('show');

                // Show training area
                document.getElementById('comparisonResultsArea').style.display = 'block';
                document.getElementById('selectorTrainingResults').innerHTML = '';

                showStatus('success', `Porovnanie dokončené: ${selectorConfigs.length} selektorov na ${result.total_features} príznakoch. Teraz môžete natrénovať model s vybranými features.`, 'compareSelectorStatus');
            } catch (error) {
                showStatus('error', `Chyba porovnania: ${error}`, 'compareSelectorStatus');
            } finally {
                showLoading(false);
            }
        }

        // Train model with features selected by all compared selectors + baseline
        async function trainAllSelectors() {
            const comparison = window._lastComparisonResult;
            if (!comparison || !comparison.selectors) {
                showStatus('error', 'Najprv spustite porovnanie selektorov', 'compareSelectorStatus');
                return;
            }
            if (!pipeline || !window.pipelineBuilt) {
                showStatus('error', 'Najprv vytvorte pipeline', 'compareSelectorStatus');
                return;
            }

            const trainRatio = window.trainTestRatio || 0.8;
            const resultsDiv = document.getElementById('selectorTrainingResults');
            resultsDiv.innerHTML = '';

            showLoading(true);
            document.getElementById('trainCompareStatus').textContent = 'Trénujem...';

            const allResults = [];

            try {
                // First train baseline (all features, no selection)
                try {
                    const t0 = performance.now();
                    const baseRaw = await pipeline.trainWithSplit(trainRatio);
                    const baseTime = performance.now() - t0;
                    const baseResult = convertWasmResult(baseRaw);
                    allResults.push({ name: 'Všetky features (baseline)', result: baseResult, indices: null, count: comparison.total_features, timeMs: baseTime });
                } catch (e) {
                    console.error('Baseline training failed:', e);
                    allResults.push({ name: 'Všetky features (baseline)', error: String(e), indices: null, count: comparison.total_features, timeMs: 0 });
                }

                // Rebuild pipeline for each selector's features
                const selectors = Array.isArray(comparison.selectors) ? comparison.selectors : [];
                for (const sel of selectors) {
                    const selData = (sel instanceof Map) ? Object.fromEntries(sel) : sel;
                    if (selData.error) {
                        allResults.push({ name: selData.selector_name || selData.config_name, error: selData.error, indices: [], count: 0 });
                        continue;
                    }

                    const indices = selData.selected_indices || [];
                    if (indices.length === 0) {
                        allResults.push({ name: selData.selector_name, error: 'Selektor nevybral žiadne features', indices: [], count: 0 });
                        continue;
                    }

                    try {
                        const t0 = performance.now();
                        const trainRaw = await pipeline.trainWithFeatureIndices(trainRatio, indices);
                        const trainTime = performance.now() - t0;
                        const trainResult = convertWasmResult(trainRaw);
                        allResults.push({ name: selData.selector_name || selData.config_name, result: trainResult, indices: indices, count: indices.length, timeMs: trainTime });
                    } catch (e) {
                        console.error(`Training with ${selData.selector_name || selData.config_name} failed:`, e);
                        allResults.push({ name: selData.selector_name || selData.config_name, error: String(e), indices: indices, count: indices.length, timeMs: 0 });
                    }
                }

                // Display results as comparison table
                renderTrainingComparison(allResults, comparison.total_features, comparison.feature_names || []);
                document.getElementById('inspectProcessedBtn').disabled = false;
                document.getElementById('trainCompareStatus').textContent = `Hotovo - ${allResults.length} variantov natrénovaných`;
            } catch (error) {
                showStatus('error', `Chyba pri trénovaní: ${error}`, 'compareSelectorStatus');
                document.getElementById('trainCompareStatus').textContent = '';
            } finally {
                showLoading(false);
            }
        }



        // Render training comparison table
        function renderTrainingComparison(allResults, totalFeatures, featureNames) {
            const resultsDiv = document.getElementById('selectorTrainingResults');
            
            // Determine if classification or regression from first successful result
            const firstSuccess = allResults.find(r => r.result);
            if (!firstSuccess) {
                // All failed - show errors
                let errHtml = '<h3 style="margin-top:20px;margin-bottom:10px;color:#e74c3c;">Všetky pokusy o trénovanie zlyhali</h3>';
                errHtml += '<ul style="color:#e74c3c;">';
                allResults.forEach(r => {
                    errHtml += `<li><strong>${r.name}</strong>: ${r.error || 'Neznáma chyba'}</li>`;
                });
                errHtml += '</ul>';
                resultsDiv.innerHTML = errHtml;
                return;
            }
            const isClassification = firstSuccess.result.evaluation_mode === 'classification';

            let html = '<h3 style="margin-top:20px;margin-bottom:10px;color:#2c3e50;">Porovnanie výsledkov tréningu</h3>';
            html += '<div style="overflow-x:auto;"><table style="width:100%;border-collapse:collapse;font-size:13px;">';
            html += '<thead><tr>';
            html += '<th style="padding:10px 8px;border:1px solid #dee2e6;background:#3498db;color:white;text-align:left;">Metóda</th>';
            html += '<th style="padding:10px 8px;border:1px solid #dee2e6;background:#3498db;color:white;text-align:center;">Features</th>';
            
            if (isClassification) {
                html += '<th style="padding:10px 8px;border:1px solid #dee2e6;background:#3498db;color:white;text-align:center;">Accuracy</th>';
                html += '<th style="padding:10px 8px;border:1px solid #dee2e6;background:#3498db;color:white;text-align:center;">F1 Score</th>';
                html += '<th style="padding:10px 8px;border:1px solid #dee2e6;background:#3498db;color:white;text-align:center;">Precision</th>';
                html += '<th style="padding:10px 8px;border:1px solid #dee2e6;background:#3498db;color:white;text-align:center;">Recall</th>';
            } else {
                html += '<th style="padding:10px 8px;border:1px solid #dee2e6;background:#3498db;color:white;text-align:center;">R2</th>';
                html += '<th style="padding:10px 8px;border:1px solid #dee2e6;background:#3498db;color:white;text-align:center;">RMSE</th>';
                html += '<th style="padding:10px 8px;border:1px solid #dee2e6;background:#3498db;color:white;text-align:center;">MSE</th>';
                html += '<th style="padding:10px 8px;border:1px solid #dee2e6;background:#3498db;color:white;text-align:center;">MAE</th>';
            }
            html += '<th style="padding:10px 8px;border:1px solid #dee2e6;background:#3498db;color:white;text-align:center;">Cas tréningu</th>';
            html += '</tr></thead><tbody>';

            // Find best values for highlighting
            let bestMetric = -Infinity;
            allResults.forEach(r => {
                if (!r.result) return;
                const val = isClassification ? r.result.accuracy : r.result.r2_score;
                if (val > bestMetric) bestMetric = val;
            });

            allResults.forEach((r, idx) => {
                const isBaseline = r.indices === null;
                const isBest = r.result && ((isClassification ? r.result.accuracy : r.result.r2_score) === bestMetric);
                const bg = isBest ? 'background:#d1ecf1;' : (idx % 2 === 0 ? 'background:#f8f9fa;' : '');
                
                html += `<tr style="${bg}">`;
                html += `<td style="padding:8px;border:1px solid #dee2e6;font-weight:${isBaseline ? 'normal' : 'bold'};">${r.name}${isBest ? ' (najlepsi)' : ''}</td>`;
                html += `<td style="padding:8px;border:1px solid #dee2e6;text-align:center;">${r.count}/${totalFeatures}</td>`;

                if (r.error) {
                    html += `<td colspan="5" style="padding:8px;border:1px solid #dee2e6;color:#e74c3c;text-align:center;">${r.error}</td>`;
                } else if (r.result) {
                    if (isClassification) {
                        html += `<td style="padding:8px;border:1px solid #dee2e6;text-align:center;font-weight:bold;color:#2980b9;">${(r.result.accuracy * 100).toFixed(2)}%</td>`;
                        html += `<td style="padding:8px;border:1px solid #dee2e6;text-align:center;">${r.result.f1_score.toFixed(4)}</td>`;
                        html += `<td style="padding:8px;border:1px solid #dee2e6;text-align:center;">${r.result.precision.toFixed(4)}</td>`;
                        html += `<td style="padding:8px;border:1px solid #dee2e6;text-align:center;">${r.result.recall.toFixed(4)}</td>`;
                    } else {
                        html += `<td style="padding:8px;border:1px solid #dee2e6;text-align:center;font-weight:bold;color:#2980b9;">${r.result.r2_score.toFixed(4)}</td>`;
                        html += `<td style="padding:8px;border:1px solid #dee2e6;text-align:center;">${r.result.rmse.toFixed(4)}</td>`;
                        html += `<td style="padding:8px;border:1px solid #dee2e6;text-align:center;">${r.result.mse.toFixed(4)}</td>`;
                        html += `<td style="padding:8px;border:1px solid #dee2e6;text-align:center;">${r.result.mae.toFixed(4)}</td>`;
                    }
                    const timeStr = r.timeMs ? `${r.timeMs.toFixed(0)} ms` : '-';
                    html += `<td style="padding:8px;border:1px solid #dee2e6;text-align:center;color:#6c757d;">${timeStr}</td>`;
                }
                html += '</tr>';
            });

            html += '</tbody></table></div>';

            // Show which features each selector picked
            html += '<details style="margin-top:15px;border:1px solid #dee2e6;">';
            html += '<summary style="padding:12px;background:#f8f9fa;cursor:pointer;font-weight:600;color:#3498db;">Vybrané features jednotlivými selektormi</summary>';
            html += '<div style="padding:15px;">';
            allResults.forEach(r => {
                if (r.indices === null) return; // skip baseline
                const names = r.indices && featureNames.length > 0 
                    ? r.indices.map(i => featureNames[i] || `[${i}]`).join(', ')
                    : (r.indices || []).join(', ');
                html += `<p><strong>${r.name}</strong> (${r.count} features): ${names || 'N/A'}</p>`;
            });
            html += '</div></details>';

            resultsDiv.innerHTML = html;
        }

        function showStatus(type, message, elementId) {
            const statusDiv = document.getElementById(elementId);
            statusDiv.className = `status ${type}`;
            statusDiv.textContent = message;
        }

        function showLoading(show) {
            document.getElementById('loadingOverlay').className = show ? 'show' : '';
        }

        // Data Inspection Functions
        async function inspectData() {
            try {
                const result = await pipeline.inspectData(10);
                const data = convertWasmResult(result);
                showDataModal('Nahraté dáta', data);
            } catch (error) {
                console.error('inspectData error:', error);
                alert('Error: ' + error);
            }
        }

        async function inspectProcessedData() {
            try {
                const result = await pipeline.inspectProcessedData(10);
                const data = convertWasmResult(result);
                showDataModal('Spracované dáta (po výbere a preprocessingu)', data);
            } catch (error) {
                alert('Error: ' + error);
            }
        }

        function showDataModal(title, data) {
            if (!data || !data.feature_names || !data.rows) {
                alert('Chyba: Neplatný formát dát z WASM. Skontrolujte konzolu pre detaily.');
                console.error('Invalid data:', data);
                return;
            }
            
            const modal = document.getElementById('dataModal');
            document.getElementById('modalTitle').textContent = title;
            
            let html = `
                <div class="feature-info">
                    <p><strong>Počet riadkov:</strong> ${data.total_rows} (zobrazených prvých ${data.shown_rows})</p>
                    <p><strong>Počet stĺpcov:</strong> ${data.total_cols}</p>
                    ${data.selected_indices ? `<p><strong>Vybrané indexy:</strong> ${JSON.stringify(data.selected_indices)}</p>` : ''}
                    ${data.preprocessing_applied ? `<p><strong>Preprocessing:</strong> Aplikovaný</p>` : ''}
                </div>

                <table class="data-table">
                    <thead>
                        <tr>
                            <th>#</th>
                            ${data.feature_names.map(name => `<th>${name}</th>`).join('')}
                            <th>${data.target_name}</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${data.rows.map((row, idx) => `
                            <tr>
                                <td><strong>${idx + 1}</strong></td>
                                ${row.map(val => `<td>${typeof val === 'number' ? val.toFixed(4) : val}</td>`).join('')}
                            </tr>
                        `).join('')}
                    </tbody>
                </table>

                ${data.shown_rows < data.total_rows ? 
                    `<p style="margin-top: 15px; color: #6c757d; font-style: italic;">
                        ... a ďalších ${data.total_rows - data.shown_rows} riadkov
                    </p>` : ''}
            `;

            document.getElementById('modalBody').innerHTML = html;
            modal.classList.add('show');
        }

        function closeModal() {
            document.getElementById('dataModal').classList.remove('show');
        }

        // Close modal on outside click
        window.onclick = function(event) {
            const modal = document.getElementById('dataModal');
            if (event.target === modal) {
                closeModal();
            }
        }

        initApp();
    </script>

    <!-- Data Inspection Modal -->
    <div id="dataModal" class="modal">
        <div class="modal-content">
            <button class="modal-close" onclick="closeModal()">&times;</button>
            <h2 id="modalTitle" style="color: #3498db; margin-bottom: 20px;"></h2>
            <div id="modalBody"></div>
        </div>
    </div>

</body>
</html>
